<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Finding demographic equilibrium • plant</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<script src="../extra.js"></script><meta property="og:title" content="Finding demographic equilibrium">
<meta property="og:description" content="plant">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">plant</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.0.</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home"></span>
     
    Home
  </a>
</li>
<li>
  <a href="../articles/plant.html">
    <span class="fas fa-tree"></span>
     
    Getting Started
  </a>
</li>
<li>
  <a href="../reference/index.html">
    <span class="fas fa-list"></span>
     
    Reference
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fas fa-book"></span>
     
    Theory
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/demography.html">Demography of plants, patches, and metacommunities</a>
    </li>
    <li>
      <a href="../articles/physiology.html">The FF16 strategy</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fas fa-file-code-o"></span>
     
    Examples
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/individuals.html">Individual plants</a>
    </li>
    <li>
      <a href="../articles/patch.html">Patches of competing plants</a>
    </li>
    <li>
      <a href="../articles/equilibrium.html">Finding demographic equilibrium</a>
    </li>
    <li>
      <a href="../articles/emergent.html">Emergent properties of patches</a>
    </li>
    <li>
      <a href="../articles/fitness.html">Calculating fitness</a>
    </li>
    <li>
      <a href="../articles/cohort_spacing.html">The cohort spacing algorithm</a>
    </li>
    <li>
      <a href="../articles/parameters.html">Changing parameters</a>
    </li>
    <li>
      <a href="../articles/strategy.html">Implementing a new strategy</a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/developer_notes.html">
    <span class="fas fa-terminal"></span>
     
    Developer Notes
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="../news/index.html">
    <span class="fas fa-newspaper-o"></span>
     
    News
  </a>
</li>
<li>
  <a href="https://github.com/traitecoevo/plant">
    <span class="fas fa-github fa-lg"></span>
     
    Github
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Finding demographic equilibrium</h1>
                        <h4 class="author">Rich FitzJohn</h4>
                        <h4 class="author">Daniel Falster</h4>
            
            <h4 class="date">2016</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/traitecoevo/plant/blob/master/vignettes/equilibrium.Rmd"><code>vignettes/equilibrium.Rmd</code></a></small>
      <div class="hidden name"><code>equilibrium.Rmd</code></div>

    </div>

    
    
<div id="background" class="section level1">
<h1 class="hasAnchor">
<a href="#background" class="anchor"></a>Background</h1>
<p>An inherent assumption of the <code>plant</code> solver is that propagules / offspring arrive at a constant rate during patch development (here called <code>seed_rain</code>), some of which survive and established, based on the competitive environment within a patch. Patches also produce new propagules that in turn colonise other patches in the meta-community.</p>
<p>We can use this relationship of propagule input and output to find the demographic equilibrium of patches with one or more species, that is, the patch structure at which propagule input equals propagule output.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/traitecoevo/plant">plant</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span>
<span class="va">n_cores</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>

<span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/scm_base_parameters.html">scm_base_parameters</a></span><span class="op">(</span><span class="st">"FF16"</span><span class="op">)</span>
<span class="va">patch</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/expand_parameters.html">expand_parameters</a></span><span class="op">(</span><span class="fu"><a href="../reference/trait_matrix.html">trait_matrix</a></span><span class="op">(</span><span class="fl">0.0825</span>, <span class="st">"lma"</span><span class="op">)</span>, <span class="va">params</span>, mutant <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
</div>
<div id="propagule-arrival-seed-rain" class="section level1">
<h1 class="hasAnchor">
<a href="#propagule-arrival-seed-rain" class="anchor"></a>Propagule arrival (seed rain)</h1>
<p>Patch arrival rate can be set via <code>seed_rain</code>. After running the patch characteristic solver, the output <code>seed_rains</code> provides the number of propagules produced during patch development:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">generate_propagule_output</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">arrival_rate</span>, <span class="va">p</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">p</span><span class="op">$</span><span class="va">seed_rain</span> <span class="op">&lt;-</span> <span class="va">arrival_rate</span>
  <span class="fu"><a href="../reference/run_scm.html">run_scm</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span><span class="op">$</span><span class="va">seed_rains</span>
<span class="op">}</span>

<span class="fu">generate_propagule_output</span><span class="op">(</span><span class="fl">1.0</span>, <span class="va">patch</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 19.8244</code></pre>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">generate_propagule_output</span><span class="op">(</span><span class="fl">10.0</span>, <span class="va">patch</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 17.63186</code></pre>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">generate_propagule_output</span><span class="op">(</span><span class="fl">50.0</span>, <span class="va">patch</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 16.58919</code></pre>
<p>We see that propagule output decreases as arrival rates increase, presumably due to increased competition from crowding.</p>
</div>
<div id="finding-equilibrium" class="section level1">
<h1 class="hasAnchor">
<a href="#finding-equilibrium" class="anchor"></a>Finding equilibrium</h1>
<p>When below the equilibrium, <code>seed_rain_out</code> returns a propagule output that is greater than the arrival rate, when above it, <code>seed_rain_out</code> returns a propagule output rate less than the arrival rate. We find demographic equlibrium by chaining several patch models together, reusing the output of one patch as the input for the next.</p>
<p>This functionality is provided by <code>equilibrium_seed_rain</code>. We enable logging to better demonstrate what is happening under the hood:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plant_log_console.html">plant_log_console</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## [2021-02-25 11:40:46.673] Activating logging to console</code></pre>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">patch_eq</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/equilibrium_seed_rain.html">equilibrium_seed_rain</a></span><span class="op">(</span><span class="va">patch</span><span class="op">)</span></code></pre></div>
<pre><code>## [2021-02-25 11:40:46.674] equilibrium&gt; Solving seed rain using iteration
## [2021-02-25 11:40:48.842] schedule&gt; 1: Splitting {20} times (141)
## [2021-02-25 11:40:51.201] schedule&gt; 2: Splitting {9} times (161)
## [2021-02-25 11:40:53.712] equilibrium&gt; eq&gt; 1: {1} -&gt; {19.97185} (delta = {18.97185})
## [2021-02-25 11:40:57.435] schedule&gt; 1: Splitting {34} times (141)
## [2021-02-25 11:41:02.191] schedule&gt; 2: Splitting {27} times (175)
## [2021-02-25 11:41:07.866] schedule&gt; 3: Splitting {9} times (202)
## [2021-02-25 11:41:13.533] schedule&gt; 4: Splitting {1} times (211)
## [2021-02-25 11:41:19.073] equilibrium&gt; eq&gt; 2: {19.97185} -&gt; {17.15125} (delta = {-2.820598})
## [2021-02-25 11:41:25.331] schedule&gt; 1: Splitting {1} times (212)
## [2021-02-25 11:41:31.546] equilibrium&gt; eq&gt; 3: {17.15125} -&gt; {17.31508} (delta = {0.1638286})
## [2021-02-25 11:41:37.799] equilibrium&gt; eq&gt; 4: {17.31508} -&gt; {17.30373} (delta = {-0.01134973})
## [2021-02-25 11:41:37.799] equilibrium&gt; Reached target accuracy (delta 1.13497e-02, 6.55482e-04 &lt; 1.00000e-03 eps)</code></pre>
<p>Here, the characteristic solver is run four times. At each iteration, the arrival rate is mapped to a propagule output (e.g. <code>{1} -&gt; {19.97}</code>), with proagule outputs used as the arrival rate for the next iteration. <code>delta</code> shows the difference between input and output and the process is repeated until an accuracy target is reached (i.e. there is little difference between input an output.)</p>
<!-- TODO: provide better description of adaptive sampling -->
<p>Note that logging also demonstrates adaptive cohort spacing algorthim that <code>plant</code> uses to refine the time steps and arrival schedule, splitting cohorts where greater accuracy is required. More on timing can be found in the <a href="https://traitecoevo.github.io/plant/articles/cohort_spacing.html">cohort scheduling algorithm</a>.</p>
<p>In this example, we see that propagule outputs quickly approach demographic equilibrium. These values can be accessed using the <code>progress</code> attribute and visualised with a cobweb plot:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cobweb</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">m</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="va">m</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, each<span class="op">=</span><span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span><span class="op">)</span>, <span class="va">...</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">approach</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">patch_eq</span>, <span class="st">"progress"</span><span class="op">)</span>
<span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span><span class="op">(</span><span class="va">approach</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">approach</span>, type<span class="op">=</span><span class="st">"n"</span>, las<span class="op">=</span><span class="fl">1</span>, xlim<span class="op">=</span><span class="va">r</span>, ylim<span class="op">=</span><span class="va">r</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, lty<span class="op">=</span><span class="fl">2</span>, col<span class="op">=</span><span class="st">"grey"</span><span class="op">)</span>
<span class="fu">cobweb</span><span class="op">(</span><span class="va">approach</span>, pch<span class="op">=</span><span class="fl">19</span>, cex<span class="op">=</span><span class="fl">.5</span>, type<span class="op">=</span><span class="st">"o"</span><span class="op">)</span></code></pre></div>
<p><img src="figure/equilibrium__equilibrium_approach-1.png"> This shows the first iteration (left) producing nearly 20 propagules, which in turn generate around 17, and so on.</p>
</div>
<div id="near-equilibrium" class="section level1">
<h1 class="hasAnchor">
<a href="#near-equilibrium" class="anchor"></a>Near equilibrium</h1>
<p>The iterative approach is valuable when the relationship between arrival rate and propagule output is highly non-linear. Near equilibrium, however, can examine this relationship more closely:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Range of arrival rates</span>
<span class="va">dr</span> <span class="op">&lt;-</span> <span class="fl">2</span>
<span class="va">arrival_rates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="va">patch_eq</span><span class="op">$</span><span class="va">seed_rain</span> <span class="op">-</span> <span class="va">dr</span>,
                    <span class="va">patch_eq</span><span class="op">$</span><span class="va">seed_rain</span> <span class="op">+</span> <span class="va">dr</span>, length.out<span class="op">=</span><span class="fl">31</span><span class="op">)</span>

<span class="co"># Run patches</span>
<span class="va">propagule_outputs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/parallel/mclapply.html">mclapply</a></span><span class="op">(</span><span class="va">arrival_rates</span>, <span class="va">generate_propagule_output</span>, 
                                     <span class="va">patch_eq</span>, mc.cores <span class="op">=</span> <span class="va">n_cores</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Plot interpolated relationship</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">arrival_rates</span>, <span class="va">propagule_outputs</span>, xlab<span class="op">=</span><span class="st">"Arrival rate"</span>,
     ylab<span class="op">=</span><span class="st">"Propagule output"</span>, las<span class="op">=</span><span class="fl">1</span>, type<span class="op">=</span><span class="st">"l"</span>, asp<span class="op">=</span><span class="fl">5</span>, col<span class="op">=</span><span class="st">"red"</span><span class="op">)</span>

<span class="co"># Compare with iteration</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, lty<span class="op">=</span><span class="fl">2</span>, col<span class="op">=</span><span class="st">"grey"</span><span class="op">)</span>
<span class="fu">cobweb</span><span class="op">(</span><span class="va">approach</span><span class="op">)</span></code></pre></div>
<p><img src="figure/equilibrium__seeds_in_seeds_out-1.png"></p>
</div>
<div id="global-function-shape" class="section level1">
<h1 class="hasAnchor">
<a href="#global-function-shape" class="anchor"></a>Global function shape</h1>
<p>It is possible, if not expensive, to evaluating the global shape of the relationship between arrival rate and propagule output. We expect patch development to differ across a wider range of arrival rates, and therefore use <code>build_schedule</code> to allow the <code>plant</code> solver to adaptively refine the arrival schedule to a desired level of accuracy (as seen in the <code>equilibrium_seed_rain</code> function):</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Adaptive scheduling</span>
<span class="va">generate_propagule_output_adaptive</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">arrival_rate</span>, <span class="va">p</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">p</span><span class="op">$</span><span class="va">seed_rain</span> <span class="op">&lt;-</span> <span class="va">arrival_rate</span>
  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/build_schedule.html">build_schedule</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">res</span>, <span class="st">"seed_rain_out"</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># Loop over range of arrival rates</span>
<span class="va">arrival_rates_global</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">approach</span><span class="op">)</span>, length.out<span class="op">=</span><span class="fl">51</span><span class="op">)</span>
<span class="va">propagule_output_global</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/parallel/mclapply.html">mclapply</a></span><span class="op">(</span><span class="va">arrival_rates_global</span>,
                                           <span class="va">generate_propagule_output_adaptive</span>,
                                           <span class="va">patch</span>, mc.cores <span class="op">=</span> <span class="va">n_cores</span><span class="op">)</span><span class="op">)</span>

<span class="co"># This is pretty patchy, which is due to incompletely refining the</span>
<span class="co"># cohort schedule, I believe.  Tighten `schedule_eps` to make the</span>
<span class="co"># curve smoother, at the cost of potentially a lot more effort.</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">arrival_rates_global</span>, <span class="va">propagule_output_global</span>,
     las<span class="op">=</span><span class="fl">1</span>, type<span class="op">=</span><span class="st">"l"</span>,
     xlab<span class="op">=</span><span class="st">"Arrival rate"</span>, ylab<span class="op">=</span><span class="st">"Propagule output"</span><span class="op">)</span>

<span class="co"># Compare with iteration</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, lty<span class="op">=</span><span class="fl">1</span>, col<span class="op">=</span><span class="st">"grey"</span><span class="op">)</span>
<span class="fu">cobweb</span><span class="op">(</span><span class="va">approach</span>, lty<span class="op">=</span><span class="fl">3</span><span class="op">)</span></code></pre></div>
<p><img src="figure/equilibrium__seeds_in_seeds_out_global-1.png"></p>
<p>Here we see the non-linear relationship of propagule output declining as arrival rates increase. The dashed grey lines show the iterative equilibrium finding results, and the solid grey line shows the point at which propagule outputs decline below arrival rates.</p>
</div>
<div id="multiple-species-at-once" class="section level1">
<h1 class="hasAnchor">
<a href="#multiple-species-at-once" class="anchor"></a>5. Multiple species at once:</h1>
<p>As always, this example is simple to extend to patches of competing species:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">lma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.0825</span>, <span class="fl">0.15</span><span class="op">)</span>
<span class="va">patch_2sp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/expand_parameters.html">expand_parameters</a></span><span class="op">(</span><span class="fu"><a href="../reference/trait_matrix.html">trait_matrix</a></span><span class="op">(</span><span class="va">lma</span>, <span class="st">"lma"</span><span class="op">)</span>, <span class="va">params</span>, mutant <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="va">patch_2sp_eq</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/equilibrium_seed_rain.html">equilibrium_seed_rain</a></span><span class="op">(</span><span class="va">patch_2sp</span><span class="op">)</span></code></pre></div>
<pre><code>## [2021-02-25 11:43:53.034] equilibrium&gt; Solving seed rain using iteration
## [2021-02-25 11:43:58.778] schedule&gt; 1: Splitting {10,22} times (141,141)
## [2021-02-25 11:44:05.116] schedule&gt; 2: Splitting {1,9} times (151,163)
## [2021-02-25 11:44:11.903] schedule&gt; 3: Splitting {0,1} times (152,172)
## [2021-02-25 11:44:18.711] equilibrium&gt; eq&gt; 1: {1, 1} -&gt; {13.10296, 15.12509} (delta = {12.10296, 14.12509})
## [2021-02-25 11:44:26.685] schedule&gt; 1: Splitting {17,26} times (141,141)
## [2021-02-25 11:44:37.157] schedule&gt; 2: Splitting {4,25} times (158,167)
## [2021-02-25 11:44:49.013] schedule&gt; 3: Splitting {1,12} times (162,192)
## [2021-02-25 11:45:01.156] equilibrium&gt; eq&gt; 2: {13.10296, 15.12509} -&gt; {12.97355, 10.06157} (delta = {-0.1294116, -5.063523})
## [2021-02-25 11:45:12.899] equilibrium&gt; eq&gt; 3: {12.97355, 10.06157} -&gt; {12.95027, 10.11194} (delta = {-0.02327726, 0.05037424})
## [2021-02-25 11:45:24.820] equilibrium&gt; eq&gt; 4: {12.95027, 10.11194} -&gt; {12.95139, 10.11231} (delta = {0.00112276, 0.0003662021})
## [2021-02-25 11:45:24.820] equilibrium&gt; Reached target accuracy (delta 1.12276e-03, 8.66978e-05 &lt; 1.00000e-03 eps)</code></pre>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">approach</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">patch_2sp_eq</span>, <span class="st">"progress"</span><span class="op">)</span></code></pre></div>
<p>Both species rapidly hone in on the equilibrium:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="va">approach</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">approach</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, type<span class="op">=</span><span class="st">"n"</span>, las<span class="op">=</span><span class="fl">1</span>, xlim<span class="op">=</span><span class="va">r</span>, ylim<span class="op">=</span><span class="va">r</span>, xlab<span class="op">=</span><span class="st">"in"</span>, ylab<span class="op">=</span><span class="st">"out"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, lty<span class="op">=</span><span class="fl">2</span>, col<span class="op">=</span><span class="st">"grey"</span><span class="op">)</span>

<span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"red"</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">cobweb</span><span class="op">(</span><span class="va">approach</span><span class="op">[</span>, <span class="va">i</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span><span class="op">]</span>, pch<span class="op">=</span><span class="fl">19</span>, cex<span class="op">=</span><span class="fl">.5</span>, type<span class="op">=</span><span class="st">"o"</span>, col<span class="op">=</span><span class="va">cols</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
<span class="op">}</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>v<span class="op">=</span><span class="va">patch_2sp_eq</span><span class="op">$</span><span class="va">seed_rain</span>, col<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, lty<span class="op">=</span><span class="fl">3</span><span class="op">)</span></code></pre></div>
<p><img src="figure/equilibrium__approach_two_species-1.png"></p>
<p>Note that the first guess position of the red species is higher than the black species, but in the end the output seed rain is lower.</p>
<p>This is the difficulty in computing multi species equilibria - the different solutions affect each other. In general multi-dimensional root finding is difficult; even knowing that there are roots is not straightforward, much less proving that we’ve converged on the “correct” root (for example [0,0] is a root in this case but that root is not stable).</p>
<p><code>plant</code> uses some heuristics to try to ensure that the root returned is an attracting point but sequentially applying rounds of iteration and non-linear root finding algorithms, as well as rescaling seed rains to repel from known unstable roots.</p>
<p>To illustrate this a little further, though still in the fairly trivial 2d case, first identify the other two equilibria.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">patches</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/mclapply.html">mclapply</a></span><span class="op">(</span><span class="va">lma</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="../reference/equilibrium_seed_rain.html">equilibrium_seed_rain</a></span><span class="op">(</span>
  <span class="fu"><a href="../reference/expand_parameters.html">expand_parameters</a></span><span class="op">(</span><span class="fu"><a href="../reference/trait_matrix.html">trait_matrix</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"lma"</span><span class="op">)</span>, <span class="va">params</span>, mutant <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span>,
  mc.cores <span class="op">=</span> <span class="va">n_cores</span><span class="op">)</span></code></pre></div>
<p>Here’s the seed rains of each species when alone:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">propagule_outputs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">patches</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">seed_rain</span><span class="op">)</span></code></pre></div>
<p>So that means that we have <em>four</em> equilibria: 1: The trivial equilibrium:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">eq00</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>
<span class="fu">generate_propagule_output</span><span class="op">(</span><span class="va">eq00</span>, <span class="va">patch_2sp_eq</span><span class="op">)</span> <span class="op">-</span> <span class="va">eq00</span></code></pre></div>
<pre><code>## [1] 0 0</code></pre>
<p>2: Species 1 alone</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">eq10</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">propagule_outputs</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="fl">0</span><span class="op">)</span>
<span class="fu">generate_propagule_output_adaptive</span><span class="op">(</span><span class="va">eq10</span>, <span class="va">patch_2sp</span><span class="op">)</span> <span class="op">-</span> <span class="va">eq10</span></code></pre></div>
<pre><code>## [2021-02-25 11:46:56.618] schedule&gt; 1: Splitting {38,0} times (141,141)
## [2021-02-25 11:47:05.710] schedule&gt; 2: Splitting {22,0} times (179,141)
## [2021-02-25 11:47:16.278] schedule&gt; 3: Splitting {11,0} times (201,141)
## [2021-02-25 11:47:27.420] schedule&gt; 4: Splitting {1,0} times (212,141)</code></pre>
<pre><code>## [1] -0.009378463  0.000000000</code></pre>
<p>3: Species 2 alone</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">eq01</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">propagule_outputs</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
<span class="fu">generate_propagule_output_adaptive</span><span class="op">(</span><span class="va">eq01</span>, <span class="va">patch_2sp</span><span class="op">)</span> <span class="op">-</span> <span class="va">eq01</span></code></pre></div>
<pre><code>## [2021-02-25 11:47:47.790] schedule&gt; 1: Splitting {0,44} times (141,141)
## [2021-02-25 11:48:00.197] schedule&gt; 2: Splitting {0,27} times (141,185)
## [2021-02-25 11:48:14.608] schedule&gt; 3: Splitting {0,19} times (141,212)
## [2021-02-25 11:48:28.690] schedule&gt; 4: Splitting {0,11} times (141,231)</code></pre>
<pre><code>## [1] 0.000000000 0.009307815</code></pre>
<p>4: Species 1 and 2 together:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">eq11</span> <span class="op">&lt;-</span> <span class="va">patch_2sp</span><span class="op">$</span><span class="va">seed_rain</span>
<span class="fu">generate_propagule_output</span><span class="op">(</span><span class="va">eq11</span>, <span class="va">patch_2sp</span><span class="op">)</span> <span class="op">-</span> <span class="va">eq11</span></code></pre></div>
<pre><code>## [1] 12.09120 13.14076</code></pre>
<p>Like before, we can describe the global relationship of arrival rate to propagule output by manually running patches for each combination of arrival rates of both species. We turn logging off because this is a looong loop:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># note that the approximations here mean that these equilibria are not</span>
<span class="co"># terribly well polished - there are a set of nested approximations that make</span>
<span class="co"># this difficult. Possibly the biggest culprit is the cohort refinement step</span>

<span class="fu"><a href="../reference/plant_log_console.html">plant_log_console</a></span><span class="op">(</span>file_name <span class="op">=</span> <span class="st">"stdout"</span><span class="op">)</span></code></pre></div>
<pre><code>## [2021-02-25 11:48:48.982] Activating logging to output
## [2021-02-25 11:48:48.982] Activating logging to output</code></pre>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">len</span> <span class="op">&lt;-</span> <span class="fl">21</span>
<span class="va">dx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">propagule_outputs</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">len</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>
<span class="va">n1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0.001</span>, by<span class="op">=</span><span class="va">dx</span>, to<span class="op">=</span><span class="va">propagule_outputs</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">+</span> <span class="va">dx</span><span class="op">)</span>
<span class="va">n2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0.001</span>, by<span class="op">=</span><span class="va">dx</span>, to<span class="op">=</span><span class="va">propagule_outputs</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op">+</span> <span class="va">dx</span><span class="op">)</span>
<span class="va">nn_in</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span><span class="va">n1</span>, <span class="va">n2</span><span class="op">)</span><span class="op">)</span>
<span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/mclapply.html">mclapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unname.html">unname</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/split.html">split</a></span><span class="op">(</span><span class="va">nn_in</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">nn_in</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
                <span class="va">generate_propagule_output_adaptive</span>, <span class="va">patch_2sp</span>,
                mc.cores <span class="op">=</span> <span class="va">n_cores</span><span class="op">)</span>
<span class="va">nn_out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="st">"rbind"</span>, <span class="va">tmp</span><span class="op">)</span>

<span class="va">len</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="op">(</span><span class="va">nn_out</span> <span class="op">-</span> <span class="va">nn_in</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">rlen</span> <span class="op">&lt;-</span> <span class="va">len</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">len</span><span class="op">)</span> <span class="op">*</span> <span class="va">dx</span> <span class="op">*</span> <span class="fl">0.8</span>

<span class="va">theta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">atan2</a></span><span class="op">(</span><span class="va">nn_out</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="va">nn_in</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>, <span class="va">nn_out</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="va">nn_in</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>

<span class="va">x1</span> <span class="op">&lt;-</span> <span class="va">nn_in</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">rlen</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">cos</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span>
<span class="va">y1</span> <span class="op">&lt;-</span> <span class="va">nn_in</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="va">rlen</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">sin</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span></code></pre></div>
<!-- TODO: check that vector field is the correct term here -->
<p>We visualise these results using a two dimensional vector field:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># NOTE: I'm not sure why the point really close to the equilibrium here looks</span>
<span class="co"># like it's moving so quickly, and possibly in the wrong direction.  </span>
<span class="co"># Cohort instability perhaps?</span>


<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">nn_in</span>, xlab<span class="op">=</span><span class="st">"Species 1"</span>, ylab<span class="op">=</span><span class="st">"Species 2"</span>, pch<span class="op">=</span><span class="fl">19</span>, cex<span class="op">=</span><span class="fl">.25</span>,
     col<span class="op">=</span><span class="st">"grey"</span>, asp<span class="op">=</span><span class="fl">1</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/arrows.html">arrows</a></span><span class="op">(</span><span class="va">nn_in</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, <span class="va">nn_in</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>, <span class="va">x1</span>, <span class="va">y1</span>, length<span class="op">=</span><span class="fl">0.02</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">approach</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span>, <span class="va">approach</span><span class="op">[</span>, <span class="fl">3</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span>, type<span class="op">=</span><span class="st">"o"</span>, col<span class="op">=</span><span class="st">"red"</span>,
      pch<span class="op">=</span><span class="fl">19</span>, cex<span class="op">=</span><span class="fl">.5</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span><span class="va">patch_2sp_eq</span><span class="op">$</span><span class="va">seed_rain</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">patch_2sp_eq</span><span class="op">$</span><span class="va">seed_rain</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, pch<span class="op">=</span><span class="fl">19</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">eq00</span>, <span class="va">eq10</span>, <span class="va">eq01</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="figure/equilibrium__unnamed-chunk-12-1.png"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Daniel Falster, Richard FitzJohn, Rafael Schouten, Andrew O'Reilly-Nugent.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
