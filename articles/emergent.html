<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Patch-level emergent properties • plant</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">plant</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
    Home
  </a>
</li>
<li>
  <a href="../articles/plant.html">
    <span class="fa fa-tree"></span>
     
    Getting Started
  </a>
</li>
<li>
  <a href="../reference/index.html">
    <span class="fa fa-list"></span>
     
    Reference
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-book"></span>
     
    Theory
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/demography.html">Demography of plants, patches, and metacommunities</a>
    </li>
    <li>
      <a href="../articles/physiology.html">The FF16 strategy</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-file-code-o"></span>
     
    Examples
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/individuals.html">Individual plants</a>
    </li>
    <li>
      <a href="../articles/patch.html">Patches of competing plants</a>
    </li>
    <li>
      <a href="../articles/equilibrium.html">Finding demographic equilibrium</a>
    </li>
    <li>
      <a href="../articles/emergent.html">Emergent properties of patches</a>
    </li>
    <li>
      <a href="../articles/fitness.html">Calculating fitness</a>
    </li>
    <li>
      <a href="../articles/cohort_spacing.html">The cohort spacing algorithm</a>
    </li>
    <li>
      <a href="../articles/parameters.html">Changing parameters</a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/developer_notes.html">
    <span class="fa fa-terminal"></span>
     
    Developer Notes
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="../news/index.html">
    <span class="fa fa-newspaper-o"></span>
     
    News
  </a>
</li>
<li>
  <a href="https://github.com/traitecoevo/plant">
    <span class="fa fa-github fa-lg"></span>
     
    Github
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Patch-level emergent properties</h1>
                        <h4 class="author">Rich FitzJohn</h4>
                        <h4 class="author">Daniel Falster</h4>
            
            <h4 class="date">2016</h4>
          </div>

    
    
<div class="contents">
<p>The aim here is to use the plant package to investigate dynamics within a patch of competing plants, focussing on emergent patch-level properties, rather than properties of plants within the patch.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(plant)

p0 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/scm_base_parameters.html">scm_base_parameters</a></span>(<span class="st">"FF16"</span>)
p0<span class="op">$</span>control<span class="op">$</span>equilibrium_nsteps &lt;-<span class="st"> </span><span class="dv">30</span>
p0<span class="op">$</span>control<span class="op">$</span>equilibrium_solver_name &lt;-<span class="st"> "hybrid"</span>
p0<span class="op">$</span>disturbance_mean_interval &lt;-<span class="st"> </span><span class="fl">30.0</span></code></pre></div>
<p>We’ll work with a single species at equilibrium</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">p1 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/expand_parameters.html">expand_parameters</a></span>(<span class="kw"><a href="../reference/trait_matrix.html">trait_matrix</a></span>(<span class="fl">0.0825</span>, <span class="st">"lma"</span>), p0, <span class="ot">FALSE</span>)
p1_eq &lt;-<span class="st"> </span><span class="kw"><a href="../reference/equilibrium_seed_rain.html">equilibrium_seed_rain</a></span>(p1)
data1 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/run_scm_collect.html">run_scm_collect</a></span>(p1_eq)</code></pre></div>
<p>There was a bit of hassle in vignette:patch in plotting all trajectories along with a couple of lines corresponding to focal years. We’re going to do the same thing here:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">closest &lt;-<span class="st"> </span><span class="cf">function</span>(t, time) {
  <span class="kw">which.min</span>(<span class="kw">abs</span>(time <span class="op">-</span><span class="st"> </span>t))
}
last &lt;-<span class="st"> </span><span class="cf">function</span>(x) {
  x[[<span class="kw">length</span>(x)]]
}

times &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">40</span>, <span class="kw">last</span>(data1<span class="op">$</span>time))
i &lt;-<span class="st"> </span><span class="kw">vapply</span>(times, closest, <span class="kw">integer</span>(<span class="dv">1</span>), data1<span class="op">$</span>time)
blues &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"#DEEBF7"</span>, <span class="st">"#C6DBEF"</span>, <span class="st">"#9ECAE1"</span>, <span class="st">"#6BAED6"</span>,
           <span class="st">"#4292C6"</span>, <span class="st">"#2171B5"</span>, <span class="st">"#08519C"</span>, <span class="st">"#08306B"</span>)
cols &lt;-<span class="st"> </span><span class="kw">colorRampPalette</span>(blues[<span class="op">-</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>)])(<span class="kw">length</span>(i))

height      &lt;-<span class="st"> </span><span class="kw">t</span>(data1<span class="op">$</span>species[[<span class="dv">1</span>]][<span class="st">"height"</span>, , ])
log_density &lt;-<span class="st"> </span><span class="kw">t</span>(data1<span class="op">$</span>species[[<span class="dv">1</span>]][<span class="st">"log_density"</span>, , ])</code></pre></div>
<p>As with height in vignette:patch, the density is a matrix of time and cohort identity. However, to show the profiles for a given time slice using <code>matplot</code> it is convenient to transpose this matrix (<code>matplot</code> works column-by-column so we want each column to to be the state of the system at a given time)</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">density &lt;-<span class="st"> </span><span class="kw">exp</span>(log_density)
<span class="kw">matplot</span>(height, density, <span class="dt">type=</span><span class="st">"l"</span>, <span class="dt">lty=</span><span class="dv">1</span>,
        <span class="dt">col=</span><span class="kw"><a href="../reference/make_transparent.html">make_transparent</a></span>(<span class="st">"black"</span>, <span class="fl">0.15</span>),
        <span class="dt">xlab=</span><span class="st">"Height (m)"</span>, <span class="dt">ylab=</span><span class="st">"Density (1 / m / m2)"</span>, <span class="dt">las=</span><span class="dv">1</span>,
        <span class="dt">log=</span><span class="st">"y"</span>)</code></pre></div>
<div class="figure">
<img src="figure/emergent__unnamed-chunk-4-1.png">
</div>
<p>Note that the densities here can be <em>extremely</em> low, and yet individuals within the cohorts continue to grow in size; this is the “<a href="http://en.wikipedia.org/wiki/Lotka-Volterra_equation">atto-fox problem</a>”, though here we drop down as low as 9 yocto plants / m / metre squared (a yocto-x being 1 millionth of an atto-x). <em>Anyway</em>….</p>
<p>The trajectories are easier to understand if a few are highlighted.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">xlim &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">max</span>(height, <span class="dt">na.rm=</span><span class="ot">TRUE</span>) <span class="op">*</span><span class="st"> </span><span class="fl">1.05</span>)
<span class="kw">matplot</span>(height, density, <span class="dt">type=</span><span class="st">"l"</span>, <span class="dt">lty=</span><span class="dv">1</span>,
        <span class="dt">col=</span><span class="kw"><a href="../reference/make_transparent.html">make_transparent</a></span>(<span class="st">"black"</span>, <span class="fl">0.15</span>),
        <span class="dt">xlab=</span><span class="st">"Height (m)"</span>, <span class="dt">ylab=</span><span class="st">"Density (1 / m / m2)"</span>, <span class="dt">las=</span><span class="dv">1</span>,
        <span class="dt">log=</span><span class="st">"y"</span>, <span class="dt">xlim=</span>xlim)
<span class="kw">matlines</span>(height[, i], density[, i], <span class="dt">col=</span>cols, <span class="dt">lty=</span><span class="dv">1</span>, <span class="dt">type=</span><span class="st">"l"</span>)
<span class="kw">points</span>(height[<span class="dv">1</span>, i], density[<span class="dv">1</span>, i], <span class="dt">pch=</span><span class="dv">19</span>, <span class="dt">col=</span>cols)
<span class="kw">text</span>(height[<span class="dv">1</span>, i] <span class="op">+</span><span class="st"> </span><span class="kw">strwidth</span>(<span class="st">"x"</span>), density[<span class="dv">1</span>, i],
     <span class="kw">paste0</span>(<span class="kw">round</span>(times), <span class="kw">c</span>(<span class="st">" years"</span>, <span class="kw">rep</span>(<span class="st">""</span>, <span class="kw">length</span>(times) <span class="op">-</span><span class="st"> </span><span class="dv">1</span>))),
     <span class="dt">adj=</span><span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>))</code></pre></div>
<div class="figure">
<img src="figure/emergent__unnamed-chunk-5-1.png">
</div>
<p>Early on there is a low density “dip” caused by self thinning (5 years). As the stand develops that dip broadens and deepens and moves forward in height (these very low density cohorts are still travelling the characteristic equations of the SCM). Later on (20 years) additional an second wave of recruitment gives a second pulse of high density (around 4 m tall), which can be seen travelling along in the 40 year profile to about 13 m. When the patch is very old the stand approaches a stable age distribution, though a very narrow window of “missing” heights exists just below the top of the canopy.</p>
<p>It’s also possible see where the leaf area in the patch is coming from; a profile of leaf area with respect to height. Again, this requires reconstructing the patches, and using an unexported function from <code>plant</code> to put this into a matrix:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">patch &lt;-<span class="st"> </span><span class="kw">lapply</span>(<span class="kw">seq_along</span>(data1<span class="op">$</span>time), scm_patch, data1)
leaf_area &lt;-<span class="st"> </span><span class="kw">lapply</span>(patch, <span class="cf">function</span>(x) x<span class="op">$</span>species[[<span class="dv">1</span>]]<span class="op">$</span>area_leafs)
leaf_area &lt;-<span class="st"> </span><span class="kw">do.call</span>(<span class="st">"cbind"</span>, plant<span class="op">:::</span><span class="kw">pad_matrix</span>(leaf_area))

<span class="kw">matplot</span>(height, leaf_area, <span class="dt">type=</span><span class="st">"l"</span>, <span class="dt">lty=</span><span class="dv">1</span>, <span class="dt">col=</span><span class="st">"lightgrey"</span>,
        <span class="dt">xlim=</span>xlim, <span class="dt">xlab=</span><span class="st">"Height (m)"</span>,
        <span class="dt">ylab=</span><span class="st">"Leaf area density (m2 / m2 / m)"</span>, <span class="dt">las=</span><span class="dv">1</span>)
<span class="kw">matlines</span>(height[, i], leaf_area[, i], <span class="dt">col=</span>cols, <span class="dt">lty=</span><span class="dv">1</span>, <span class="dt">type=</span><span class="st">"l"</span>)
<span class="kw">points</span>(height[<span class="dv">1</span>, i], leaf_area[<span class="dv">1</span>, i], <span class="dt">pch=</span><span class="dv">19</span>, <span class="dt">col=</span>cols)
<span class="kw">text</span>(height[<span class="dv">1</span>, i] <span class="op">+</span><span class="st"> </span><span class="kw">strwidth</span>(<span class="st">"x"</span>), leaf_area[<span class="dv">1</span>, i],
     <span class="kw">paste0</span>(<span class="kw">round</span>(times), <span class="kw">c</span>(<span class="st">" years"</span>, <span class="kw">rep</span>(<span class="st">""</span>, <span class="kw">length</span>(times) <span class="op">-</span><span class="st"> </span><span class="dv">1</span>))),
     <span class="dt">adj=</span><span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>))</code></pre></div>
<div class="figure">
<img src="figure/emergent__unnamed-chunk-6-1.png">
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ode_size &lt;-<span class="st"> </span>patch[[<span class="dv">1</span>]]<span class="op">$</span>species[[<span class="dv">1</span>]]<span class="op">$</span>seed<span class="op">$</span>ode_size
growth_rate &lt;-<span class="st"> </span><span class="kw">lapply</span>(patch, <span class="cf">function</span>(x)
                      <span class="kw">matrix</span>(x<span class="op">$</span>species[[<span class="dv">1</span>]]<span class="op">$</span>ode_rates, ode_size)[<span class="dv">1</span>, ])
growth_rate &lt;-<span class="st"> </span><span class="kw">do.call</span>(<span class="st">"cbind"</span>, plant<span class="op">:::</span><span class="kw">pad_matrix</span>(growth_rate))</code></pre></div>
<p>Finally, we can see where height growth rate is concentrated in the population. This differs from the profile in vignette:plant because it is reduced depending on the light environment, but that environment is the one constructed by the plant itself.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">matplot</span>(height, growth_rate, <span class="dt">type=</span><span class="st">"l"</span>, <span class="dt">lty=</span><span class="dv">1</span>, <span class="dt">col=</span><span class="st">"lightgrey"</span>,
        <span class="dt">xlim=</span>xlim, <span class="dt">xlab=</span><span class="st">"Height (m)"</span>,
        <span class="dt">ylab=</span><span class="st">"Height growth rate (m / year)"</span>, <span class="dt">las=</span><span class="dv">1</span>)
<span class="kw">matlines</span>(height[, i], growth_rate[, i], <span class="dt">col=</span>cols, <span class="dt">lty=</span><span class="dv">1</span>, <span class="dt">type=</span><span class="st">"l"</span>)
<span class="kw">points</span>(height[<span class="dv">1</span>, i], growth_rate[<span class="dv">1</span>, i], <span class="dt">pch=</span><span class="dv">19</span>, <span class="dt">col=</span>cols)
<span class="kw">text</span>(height[<span class="dv">1</span>, i] <span class="op">+</span><span class="st"> </span><span class="kw">strwidth</span>(<span class="st">"x"</span>), growth_rate[<span class="dv">1</span>, i],
     <span class="kw">paste0</span>(<span class="kw">round</span>(times), <span class="kw">c</span>(<span class="st">" years"</span>, <span class="kw">rep</span>(<span class="st">""</span>, <span class="kw">length</span>(times) <span class="op">-</span><span class="st"> </span><span class="dv">1</span>))),
     <span class="dt">adj=</span><span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>))</code></pre></div>
<div class="figure">
<img src="figure/emergent__unnamed-chunk-7-1.png">
</div>
<p>The above plots show relationships with patches of a given age What about the average relationship across the entire metapopulation? To get that, we average (integrate) over the distribution over patch (for formula see demography vignette). To achieve this we first need the patch-level relationships to a series of fixed heights</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">hh &lt;-<span class="st"> </span><span class="kw"><a href="../reference/seq_log.html">seq_log_range</a></span>(<span class="kw">range</span>(height, <span class="dt">na.rm=</span><span class="ot">TRUE</span>), <span class="dv">500</span>)</code></pre></div>
<p>We’ll use a spline interpolation, on log-log-scaled data, clamped so that for x values outside the observed range are set to zero.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">f &lt;-<span class="st"> </span><span class="cf">function</span>(height, density, hout) {
  r &lt;-<span class="st"> </span><span class="kw">range</span>(height, <span class="dt">na.rm=</span><span class="ot">TRUE</span>)
  <span class="kw"><a href="../reference/clamp_domain.html">clamp_domain</a></span>(<span class="kw"><a href="../reference/splinefun_log.html">splinefun_loglog</a></span>(height, density), r, <span class="dv">0</span>)(hout)
}</code></pre></div>
<p>Now interpolate the height-density relationship in each patch to the series of specified heights</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">xx &lt;-<span class="st"> </span><span class="kw">lapply</span>(<span class="kw">seq_along</span>(data1<span class="op">$</span>time),
             <span class="cf">function</span>(i) <span class="kw">f</span>(height[, i], density[, i], hh))
n_hh &lt;-<span class="st"> </span>plant<span class="op">:::</span><span class="kw">pad_list_to_array</span>(xx)</code></pre></div>
<p>For each of these heights, we can now integrate across patches (i.e. across rows), weighting by patch abundance</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">trapezium &lt;-<span class="st"> </span>plant<span class="op">:::</span>trapezium
n_av &lt;-<span class="st"> </span><span class="kw">apply</span>(n_hh, <span class="dv">1</span>,
              <span class="cf">function</span>(x) <span class="kw">trapezium</span>(data1<span class="op">$</span>time, x <span class="op">*</span><span class="st"> </span>data1<span class="op">$</span>patch_density))</code></pre></div>
<p>Add this average to the plot (red line):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">xlim &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">max</span>(height, <span class="dt">na.rm=</span><span class="ot">TRUE</span>) <span class="op">*</span><span class="st"> </span><span class="fl">1.05</span>)
<span class="kw">matplot</span>(height, density, <span class="dt">type=</span><span class="st">"l"</span>, <span class="dt">lty=</span><span class="dv">1</span>,
        <span class="dt">col=</span><span class="kw"><a href="../reference/make_transparent.html">make_transparent</a></span>(<span class="st">"black"</span>, <span class="fl">0.15</span>),
        <span class="dt">xlab=</span><span class="st">"Height (m)"</span>, <span class="dt">ylab=</span><span class="st">"Density (1 / m / m2)"</span>, <span class="dt">las=</span><span class="dv">1</span>,
        <span class="dt">log=</span><span class="st">"y"</span>, <span class="dt">xlim=</span>xlim)
<span class="kw">matlines</span>(height[, i], density[, i], <span class="dt">col=</span>cols, <span class="dt">lty=</span><span class="dv">1</span>, <span class="dt">type=</span><span class="st">"l"</span>)
<span class="kw">points</span>(height[<span class="dv">1</span>, i], density[<span class="dv">1</span>, i], <span class="dt">pch=</span><span class="dv">19</span>, <span class="dt">col=</span>cols)
<span class="kw">text</span>(height[<span class="dv">1</span>, i] <span class="op">+</span><span class="st"> </span><span class="kw">strwidth</span>(<span class="st">"x"</span>), density[<span class="dv">1</span>, i],
     <span class="kw">paste0</span>(<span class="kw">round</span>(times), <span class="kw">c</span>(<span class="st">" years"</span>, <span class="kw">rep</span>(<span class="st">""</span>, <span class="kw">length</span>(times) <span class="op">-</span><span class="st"> </span><span class="dv">1</span>))),
     <span class="dt">adj=</span><span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>))
<span class="kw">points</span>(hh, n_av, <span class="dt">col=</span><span class="st">"red"</span>, <span class="dt">type=</span><span class="st">'l'</span>)</code></pre></div>
<div class="figure">
<img src="figure/emergent__unnamed-chunk-12-1.png">
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Daniel Falster, Richard FitzJohn.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
