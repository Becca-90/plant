<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Patch-level emergent properties • plant</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<script src="../extra.js"></script><meta property="og:title" content="Patch-level emergent properties">
<meta property="og:description" content="plant">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">plant</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.0.</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home"></span>
     
    Home
  </a>
</li>
<li>
  <a href="../articles/plant.html">
    <span class="fas fa-tree"></span>
     
    Getting Started
  </a>
</li>
<li>
  <a href="../reference/index.html">
    <span class="fas fa-list"></span>
     
    Reference
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fas fa-book"></span>
     
    Theory
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/demography.html">Demography of plants, patches, and metacommunities</a>
    </li>
    <li>
      <a href="../articles/physiology.html">The FF16 strategy</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fas fa-file-code-o"></span>
     
    Examples
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/individuals.html">Individual plants</a>
    </li>
    <li>
      <a href="../articles/patch.html">Patches of competing plants</a>
    </li>
    <li>
      <a href="../articles/equilibrium.html">Finding demographic equilibrium</a>
    </li>
    <li>
      <a href="../articles/emergent.html">Emergent properties of patches</a>
    </li>
    <li>
      <a href="../articles/fitness.html">Calculating fitness</a>
    </li>
    <li>
      <a href="../articles/cohort_spacing.html">The cohort spacing algorithm</a>
    </li>
    <li>
      <a href="../articles/parameters.html">Changing parameters</a>
    </li>
    <li>
      <a href="../articles/strategy.html">Implementing a new strategy</a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/developer_notes.html">
    <span class="fas fa-terminal"></span>
     
    Developer Notes
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="../news/index.html">
    <span class="fas fa-newspaper-o"></span>
     
    News
  </a>
</li>
<li>
  <a href="https://github.com/traitecoevo/plant">
    <span class="fas fa-github fa-lg"></span>
     
    Github
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Patch-level emergent properties</h1>
                        <h4 class="author">Rich FitzJohn</h4>
                        <h4 class="author">Daniel Falster</h4>
            
            <h4 class="date">2016</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/traitecoevo/plant/blob/master/vignettes/emergent.Rmd"><code>vignettes/emergent.Rmd</code></a></small>
      <div class="hidden name"><code>emergent.Rmd</code></div>

    </div>

    
    
<div id="background" class="section level1">
<h1 class="hasAnchor">
<a href="#background" class="anchor"></a>Background</h1>
<p>The aim here is to use the plant package to investigate dynamics within a patch of competing individuals, focusing on emergent patch-level properties, rather than properties of individuals within the patch. We’ll work with a single species at demographic equilibrium:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/traitecoevo/plant">plant</a></span><span class="op">)</span>

<span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/scm_base_parameters.html">scm_base_parameters</a></span><span class="op">(</span><span class="st">"FF16"</span><span class="op">)</span>
<span class="va">patch</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/expand_parameters.html">expand_parameters</a></span><span class="op">(</span><span class="fu"><a href="../reference/trait_matrix.html">trait_matrix</a></span><span class="op">(</span><span class="fl">0.0825</span>, <span class="st">"lma"</span><span class="op">)</span>, <span class="va">params</span>, mutant <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="va">patch_eq</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/equilibrium_seed_rain.html">equilibrium_seed_rain</a></span><span class="op">(</span><span class="va">patch</span><span class="op">)</span></code></pre></div>
<pre><code>## [2021-02-24 21:43:13.133] equilibrium&gt; Solving seed rain using iteration
## [2021-02-24 21:43:13.133] equilibrium&gt; Solving seed rain using iteration
## [2021-02-24 21:43:15.316] schedule&gt; 1: Splitting {20} times (141)
## [2021-02-24 21:43:15.316] schedule&gt; 1: Splitting {20} times (141)
## [2021-02-24 21:43:17.673] schedule&gt; 2: Splitting {9} times (161)
## [2021-02-24 21:43:17.673] schedule&gt; 2: Splitting {9} times (161)
## [2021-02-24 21:43:20.185] equilibrium&gt; eq&gt; 1: {1} -&gt; {19.97185} (delta = {18.97185})
## [2021-02-24 21:43:20.185] equilibrium&gt; eq&gt; 1: {1} -&gt; {19.97185} (delta = {18.97185})
## [2021-02-24 21:43:23.918] schedule&gt; 1: Splitting {34} times (141)
## [2021-02-24 21:43:23.918] schedule&gt; 1: Splitting {34} times (141)
## [2021-02-24 21:43:28.684] schedule&gt; 2: Splitting {27} times (175)
## [2021-02-24 21:43:28.684] schedule&gt; 2: Splitting {27} times (175)
## [2021-02-24 21:43:34.365] schedule&gt; 3: Splitting {9} times (202)
## [2021-02-24 21:43:34.365] schedule&gt; 3: Splitting {9} times (202)
## [2021-02-24 21:43:39.920] schedule&gt; 4: Splitting {1} times (211)
## [2021-02-24 21:43:39.920] schedule&gt; 4: Splitting {1} times (211)
## [2021-02-24 21:43:45.452] equilibrium&gt; eq&gt; 2: {19.97185} -&gt; {17.15125} (delta = {-2.820598})
## [2021-02-24 21:43:45.452] equilibrium&gt; eq&gt; 2: {19.97185} -&gt; {17.15125} (delta = {-2.820598})
## [2021-02-24 21:43:51.681] schedule&gt; 1: Splitting {1} times (212)
## [2021-02-24 21:43:51.681] schedule&gt; 1: Splitting {1} times (212)
## [2021-02-24 21:43:57.905] equilibrium&gt; eq&gt; 3: {17.15125} -&gt; {17.31508} (delta = {0.1638286})
## [2021-02-24 21:43:57.905] equilibrium&gt; eq&gt; 3: {17.15125} -&gt; {17.31508} (delta = {0.1638286})
## [2021-02-24 21:44:04.226] equilibrium&gt; eq&gt; 4: {17.31508} -&gt; {17.30373} (delta = {-0.01134973})
## [2021-02-24 21:44:04.226] equilibrium&gt; eq&gt; 4: {17.31508} -&gt; {17.30373} (delta = {-0.01134973})
## [2021-02-24 21:44:04.227] equilibrium&gt; Reached target accuracy (delta 1.13497e-02, 6.55482e-04 &lt; 1.00000e-03 eps)
## [2021-02-24 21:44:04.227] equilibrium&gt; Reached target accuracy (delta 1.13497e-02, 6.55482e-04 &lt; 1.00000e-03 eps)</code></pre>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_scm_collect.html">run_scm_collect</a></span><span class="op">(</span><span class="va">patch_eq</span><span class="op">)</span></code></pre></div>
</div>
<div id="cohort-densities" class="section level1">
<h1 class="hasAnchor">
<a href="#cohort-densities" class="anchor"></a>Cohort densities</h1>
<p>There was a bit of hassle in <a href="https://traitecoevo.github.io/plant/articles/patch.html">Patches vignette</a> in plotting all trajectories along with a couple of lines corresponding to focal years. We’re going to do the same thing here:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">closest</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">t</span>, <span class="va">time</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/which.min.html">which.min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">time</span> <span class="op">-</span> <span class="va">t</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">last</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">x</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">]</span><span class="op">]</span>
<span class="op">}</span>

<span class="va">times</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">10</span>, <span class="fl">20</span>, <span class="fl">40</span>, <span class="fu">last</span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">time</span><span class="op">)</span><span class="op">)</span>
<span class="va">i</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">vapply</a></span><span class="op">(</span><span class="va">times</span>, <span class="va">closest</span>, <span class="fu"><a href="https://rdrr.io/r/base/integer.html">integer</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, <span class="va">result</span><span class="op">$</span><span class="va">time</span><span class="op">)</span>
<span class="va">blues</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"#DEEBF7"</span>, <span class="st">"#C6DBEF"</span>, <span class="st">"#9ECAE1"</span>, <span class="st">"#6BAED6"</span>,
           <span class="st">"#4292C6"</span>, <span class="st">"#2171B5"</span>, <span class="st">"#08519C"</span>, <span class="st">"#08306B"</span><span class="op">)</span>
<span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/colorRamp.html">colorRampPalette</a></span><span class="op">(</span><span class="va">blues</span><span class="op">[</span><span class="op">-</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span><span class="op">)</span>

<span class="va">height</span>      <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">species</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="st">"height"</span>, , <span class="op">]</span><span class="op">)</span>
<span class="va">log_density</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">species</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="st">"log_density"</span>, , <span class="op">]</span><span class="op">)</span></code></pre></div>
<p>As with height in the <a href="https://traitecoevo.github.io/plant/articles/patch.html">Patches vignette</a>, cohort density is a matrix of time and cohort identity. However, to show the profiles for a given time slice using <code>matplot</code> it is convenient to transpose this matrix (<code>matplot</code> works column-by-column so we want each column to to be the state of the system at a given time):</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">density</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">log_density</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html">matplot</a></span><span class="op">(</span><span class="va">height</span>, <span class="va">density</span>, type<span class="op">=</span><span class="st">"l"</span>, lty<span class="op">=</span><span class="fl">1</span>,
        col<span class="op">=</span><span class="fu"><a href="../reference/make_transparent.html">make_transparent</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="fl">0.15</span><span class="op">)</span>,
        xlab<span class="op">=</span><span class="st">"Height (m)"</span>, ylab<span class="op">=</span><span class="st">"Density (1 / m / m2)"</span>, las<span class="op">=</span><span class="fl">1</span>,
        log<span class="op">=</span><span class="st">"y"</span><span class="op">)</span></code></pre></div>
<p><img src="figure/emergent__unnamed-chunk-3-1.png"></p>
<p>Note that the densities here can be <em>extremely</em> low, and yet individuals within the cohorts continue to grow in size; this is the “<a href="http://en.wikipedia.org/wiki/Lotka-Volterra_equation">atto-fox problem</a>”, though here we drop down as low as 8 yocto individuals / m / metre squared (a yocto-x being 1 millionth of an atto-x). <em>Anyway</em>….</p>
<p>The trajectories are easier to understand if a few are highlighted.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">xlim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">height</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op">*</span> <span class="fl">1.05</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html">matplot</a></span><span class="op">(</span><span class="va">height</span>, <span class="va">density</span>, type<span class="op">=</span><span class="st">"l"</span>, lty<span class="op">=</span><span class="fl">1</span>,
        col<span class="op">=</span><span class="fu"><a href="../reference/make_transparent.html">make_transparent</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="fl">0.15</span><span class="op">)</span>,
        xlab<span class="op">=</span><span class="st">"Height (m)"</span>, ylab<span class="op">=</span><span class="st">"Density (1 / m / m2)"</span>, las<span class="op">=</span><span class="fl">1</span>,
        log<span class="op">=</span><span class="st">"y"</span>, xlim<span class="op">=</span><span class="va">xlim</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html">matlines</a></span><span class="op">(</span><span class="va">height</span><span class="op">[</span>, <span class="va">i</span><span class="op">]</span>, <span class="va">density</span><span class="op">[</span>, <span class="va">i</span><span class="op">]</span>, col<span class="op">=</span><span class="va">cols</span>, lty<span class="op">=</span><span class="fl">1</span>, type<span class="op">=</span><span class="st">"l"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span><span class="va">height</span><span class="op">[</span><span class="fl">1</span>, <span class="va">i</span><span class="op">]</span>, <span class="va">density</span><span class="op">[</span><span class="fl">1</span>, <span class="va">i</span><span class="op">]</span>, pch<span class="op">=</span><span class="fl">19</span>, col<span class="op">=</span><span class="va">cols</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="va">height</span><span class="op">[</span><span class="fl">1</span>, <span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/graphics/strwidth.html">strwidth</a></span><span class="op">(</span><span class="st">"x"</span><span class="op">)</span>, <span class="va">density</span><span class="op">[</span><span class="fl">1</span>, <span class="va">i</span><span class="op">]</span>,
     <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">times</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">" years"</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">times</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
     adj<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="figure/emergent__unnamed-chunk-4-1.png"></p>
<p>Early on there is a low density “dip” caused by self thinning (5 years). As the stand develops that dip broadens and deepens and moves forward in height (these very low density cohorts are still traveling the characteristic equations of the SCM). Later on (20 years) additional an second wave of recruitment gives a second pulse of high density (around 4 m tall), which can be seen traveling along in the 40 year profile to about 13 m. When the patch is very old the stand approaches a stable age distribution, though a very narrow window of “missing” heights exists just below the top of the canopy.</p>
</div>
<div id="leaf-area" class="section level1">
<h1 class="hasAnchor">
<a href="#leaf-area" class="anchor"></a>Leaf area</h1>
<p>It’s also possible see where the leaf area in the patch is coming from; a profile of leaf area with respect to height. Again, this requires reconstructing the patches, and using an unexported function from <code>plant</code> to put this into a matrix:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">patches</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">time</span><span class="op">)</span>, <span class="va">scm_patch</span>, <span class="va">result</span><span class="op">)</span>
<span class="va">leaf_area</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">patches</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">species</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">competition_effects</span><span class="op">)</span>
<span class="va">leaf_area</span> <span class="op">&lt;-</span> <span class="fu">plant</span><span class="fu">:::</span><span class="fu">pad_list_to_array</span><span class="op">(</span><span class="va">leaf_area</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html">matplot</a></span><span class="op">(</span><span class="va">height</span>, <span class="va">leaf_area</span>, type<span class="op">=</span><span class="st">"l"</span>, lty<span class="op">=</span><span class="fl">1</span>, col<span class="op">=</span><span class="st">"lightgrey"</span>,
        xlim<span class="op">=</span><span class="va">xlim</span>, xlab<span class="op">=</span><span class="st">"Height (m)"</span>,
        ylab<span class="op">=</span><span class="st">"Leaf area density (m2 / m2 / m)"</span>, las<span class="op">=</span><span class="fl">1</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html">matlines</a></span><span class="op">(</span><span class="va">height</span><span class="op">[</span>, <span class="va">i</span><span class="op">]</span>, <span class="va">leaf_area</span><span class="op">[</span>, <span class="va">i</span><span class="op">]</span>, col<span class="op">=</span><span class="va">cols</span>, lty<span class="op">=</span><span class="fl">1</span>, type<span class="op">=</span><span class="st">"l"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span><span class="va">height</span><span class="op">[</span><span class="fl">1</span>, <span class="va">i</span><span class="op">]</span>, <span class="va">leaf_area</span><span class="op">[</span><span class="fl">1</span>, <span class="va">i</span><span class="op">]</span>, pch<span class="op">=</span><span class="fl">19</span>, col<span class="op">=</span><span class="va">cols</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="va">height</span><span class="op">[</span><span class="fl">1</span>, <span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/graphics/strwidth.html">strwidth</a></span><span class="op">(</span><span class="st">"x"</span><span class="op">)</span>, <span class="va">leaf_area</span><span class="op">[</span><span class="fl">1</span>, <span class="va">i</span><span class="op">]</span>,
     <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">times</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">" years"</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">times</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
     adj<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="figure/emergent__unnamed-chunk-5-1.png"> # Growth rate</p>
<p>Finally, we can see where height growth rate is concentrated in the population. This differs from the profile in the <a href="https://traitecoevo.github.io/plant/articles/individuals.html">Individuals vignette</a> because it is reduced depending on the light environment, but that environment is the one constructed by the individual itself.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ode_size</span> <span class="op">&lt;-</span> <span class="va">patches</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">ode_size</span>

<span class="va">growth_rate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">patches</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
                      <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">species</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">ode_rates</span>, <span class="va">ode_size</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span><span class="op">)</span>
<span class="va">growth_rate</span> <span class="op">&lt;-</span> <span class="fu">plant</span><span class="fu">:::</span><span class="fu">pad_list_to_array</span><span class="op">(</span><span class="va">growth_rate</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html">matplot</a></span><span class="op">(</span><span class="va">height</span>, <span class="va">growth_rate</span>, type<span class="op">=</span><span class="st">"l"</span>, lty<span class="op">=</span><span class="fl">1</span>, col<span class="op">=</span><span class="st">"lightgrey"</span>,
        xlim<span class="op">=</span><span class="va">xlim</span>, xlab<span class="op">=</span><span class="st">"Height (m)"</span>,
        ylab<span class="op">=</span><span class="st">"Height growth rate (m / year)"</span>, las<span class="op">=</span><span class="fl">1</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html">matlines</a></span><span class="op">(</span><span class="va">height</span><span class="op">[</span>, <span class="va">i</span><span class="op">]</span>, <span class="va">growth_rate</span><span class="op">[</span>, <span class="va">i</span><span class="op">]</span>, col<span class="op">=</span><span class="va">cols</span>, lty<span class="op">=</span><span class="fl">1</span>, type<span class="op">=</span><span class="st">"l"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span><span class="va">height</span><span class="op">[</span><span class="fl">1</span>, <span class="va">i</span><span class="op">]</span>, <span class="va">growth_rate</span><span class="op">[</span><span class="fl">1</span>, <span class="va">i</span><span class="op">]</span>, pch<span class="op">=</span><span class="fl">19</span>, col<span class="op">=</span><span class="va">cols</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="va">height</span><span class="op">[</span><span class="fl">1</span>, <span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/graphics/strwidth.html">strwidth</a></span><span class="op">(</span><span class="st">"x"</span><span class="op">)</span>, <span class="va">growth_rate</span><span class="op">[</span><span class="fl">1</span>, <span class="va">i</span><span class="op">]</span>,
     <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">times</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">" years"</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">times</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
     adj<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="figure/emergent__unnamed-chunk-6-1.png"> # Integrating over a metapopulation</p>
<p>The above plots show relationships with patches of a given age What about the average relationship across the entire metapopulation? To get that, we average (integrate) over the distribution over patch (for formula see demography vignette). To achieve this we first need the patch-level relationships to a series of fixed heights</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">hh</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/seq_log.html">seq_log_range</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span><span class="op">(</span><span class="va">height</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>, <span class="fl">500</span><span class="op">)</span></code></pre></div>
<p>We’ll use a spline interpolation, on log-log-scaled data, clamped so that for x values outside the observed range are set to zero.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">f</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">height</span>, <span class="va">density</span>, <span class="va">hout</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span><span class="op">(</span><span class="va">height</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
  <span class="fu"><a href="../reference/clamp_domain.html">clamp_domain</a></span><span class="op">(</span><span class="fu"><a href="../reference/splinefun_log.html">splinefun_loglog</a></span><span class="op">(</span><span class="va">height</span>, <span class="va">density</span><span class="op">)</span>, <span class="va">r</span>, <span class="fl">0</span><span class="op">)</span><span class="op">(</span><span class="va">hout</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Now interpolate the height-density relationship in each patch to the series of specified heights</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">xx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">time</span><span class="op">)</span>,
             <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="fu">f</span><span class="op">(</span><span class="va">height</span><span class="op">[</span>, <span class="va">i</span><span class="op">]</span>, <span class="va">density</span><span class="op">[</span>, <span class="va">i</span><span class="op">]</span>, <span class="va">hh</span><span class="op">)</span><span class="op">)</span>
<span class="va">n_hh</span> <span class="op">&lt;-</span> <span class="fu">plant</span><span class="fu">:::</span><span class="fu">pad_list_to_array</span><span class="op">(</span><span class="va">xx</span><span class="op">)</span></code></pre></div>
<p>For each of these heights, we can now integrate across patches (i.e. across rows), weighting by patch abundance</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">trapezium</span> <span class="op">&lt;-</span> <span class="fu">plant</span><span class="fu">:::</span><span class="va">trapezium</span>
<span class="va">n_av</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">n_hh</span>, <span class="fl">1</span>,
              <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">trapezium</span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">time</span>, <span class="va">x</span> <span class="op">*</span> <span class="va">result</span><span class="op">$</span><span class="va">patch_density</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Add this average to the plot (red line):</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">xlim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">height</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op">*</span> <span class="fl">1.05</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html">matplot</a></span><span class="op">(</span><span class="va">height</span>, <span class="va">density</span>, type<span class="op">=</span><span class="st">"l"</span>, lty<span class="op">=</span><span class="fl">1</span>,
        col<span class="op">=</span><span class="fu"><a href="../reference/make_transparent.html">make_transparent</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="fl">0.15</span><span class="op">)</span>,
        xlab<span class="op">=</span><span class="st">"Height (m)"</span>, ylab<span class="op">=</span><span class="st">"Density (1 / m / m2)"</span>, las<span class="op">=</span><span class="fl">1</span>,
        log<span class="op">=</span><span class="st">"y"</span>, xlim<span class="op">=</span><span class="va">xlim</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html">matlines</a></span><span class="op">(</span><span class="va">height</span><span class="op">[</span>, <span class="va">i</span><span class="op">]</span>, <span class="va">density</span><span class="op">[</span>, <span class="va">i</span><span class="op">]</span>, col<span class="op">=</span><span class="va">cols</span>, lty<span class="op">=</span><span class="fl">1</span>, type<span class="op">=</span><span class="st">"l"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span><span class="va">height</span><span class="op">[</span><span class="fl">1</span>, <span class="va">i</span><span class="op">]</span>, <span class="va">density</span><span class="op">[</span><span class="fl">1</span>, <span class="va">i</span><span class="op">]</span>, pch<span class="op">=</span><span class="fl">19</span>, col<span class="op">=</span><span class="va">cols</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="va">height</span><span class="op">[</span><span class="fl">1</span>, <span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/graphics/strwidth.html">strwidth</a></span><span class="op">(</span><span class="st">"x"</span><span class="op">)</span>, <span class="va">density</span><span class="op">[</span><span class="fl">1</span>, <span class="va">i</span><span class="op">]</span>,
     <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">times</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">" years"</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">times</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
     adj<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span><span class="va">hh</span>, <span class="va">n_av</span>, col<span class="op">=</span><span class="st">"red"</span>, type<span class="op">=</span><span class="st">'l'</span><span class="op">)</span></code></pre></div>
<p><img src="figure/emergent__unnamed-chunk-11-1.png"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Daniel Falster, Richard FitzJohn, Rafael Schouten, Andrew O'Reilly-Nugent.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
