<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Implementing Kohyama 1993 • plant</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<script src="../extra.js"></script><meta property="og:title" content="Implementing Kohyama 1993">
<meta property="og:description" content="plant">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">plant</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.0.</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home"></span>
     
    Home
  </a>
</li>
<li>
  <a href="../articles/plant.html">
    <span class="fas fa-tree"></span>
     
    Getting Started
  </a>
</li>
<li>
  <a href="../reference/index.html">
    <span class="fas fa-list"></span>
     
    Reference
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fas fa-book"></span>
     
    Theory
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/demography.html">Demography of plants, patches, and metacommunities</a>
    </li>
    <li>
      <a href="../articles/physiology.html">The FF16 strategy</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fas fa-file-code-o"></span>
     
    Examples
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/individuals.html">Individual plants</a>
    </li>
    <li>
      <a href="../articles/patch.html">Patches of competing plants</a>
    </li>
    <li>
      <a href="../articles/equilibrium.html">Finding demographic equilibrium</a>
    </li>
    <li>
      <a href="../articles/emergent.html">Emergent properties of patches</a>
    </li>
    <li>
      <a href="../articles/fitness.html">Calculating fitness</a>
    </li>
    <li>
      <a href="../articles/cohort_spacing.html">The cohort spacing algorithm</a>
    </li>
    <li>
      <a href="../articles/parameters.html">Changing parameters</a>
    </li>
    <li>
      <a href="../articles/strategy.html">Implementing a new strategy</a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/developer_notes.html">
    <span class="fas fa-terminal"></span>
     
    Developer Notes
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="../news/index.html">
    <span class="fas fa-newspaper-o"></span>
     
    News
  </a>
</li>
<li>
  <a href="https://github.com/traitecoevo/plant">
    <span class="fas fa-github fa-lg"></span>
     
    Github
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Implementing Kohyama 1993</h1>
            <h3 class="subtitle">A forest architecture hypothesis for the stable coexistence of species</h3>
                        <h4 class="author">Andrew O’Reilly-Nugent</h4>
            
            <h4 class="date">August 28, 2020</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/traitecoevo/plant/blob/master/vignettes/strategy.Rmd"><code>vignettes/strategy.Rmd</code></a></small>
      <div class="hidden name"><code>strategy.Rmd</code></div>

    </div>

    
    
<div id="under-construction" class="section level1">
<h1 class="hasAnchor">
<a href="#under-construction" class="anchor"></a>🚧 Under construction 🚧</h1>
<p>This vignette is still under active development. Some parts may appear incomplete or refer to a previous version of <code>plant</code>. We include it as reference material for advanced users looking to develop their own modules. Please raise issues or pull requests any time you encounter a mistake or area for improvement.</p>
</div>
<div id="background" class="section level1">
<h1 class="hasAnchor">
<a href="#background" class="anchor"></a>Background</h1>
<p><code>plant</code> is a generalised characteristic solver for models of size-structured competition and patch dynamics. Any <code>plant</code> model defines a strategy that implements a system of equations describing the change of one or more characteristics (state variables) of individuals. These individuals are aggregated as cohorts of different ages that compete within a patch. Competition occurs through a shared environment, where individuals reduce the resources available within the patch and limit the growth of the surrounding community. The <code>plant</code> solver steps these equations through time, integrating over a meta-population of patches and adaptively refining the rate at which cohorts are introduced, to describe the expected development of patch dynamics.</p>
<p>Phew.</p>
<p><code>plant</code> has a lot of moving parts but, helpfully, most of these are general and will work for many (all? 🤞) size structured models. Implementing a new model typically involves only changing the Strategy and sometimes the Environment classes, using existing models as a template. Below we describe the classes of <code>plant</code> that provide the basic building blocks, then implement a new model as an example. For users more interested in exploring an existing model, we refer to <a href="vignette2">vignette 2</a>.</p>
<div id="c-classes" class="section level2">
<h2 class="hasAnchor">
<a href="#c-classes" class="anchor"></a>C++ Classes</h2>
<p><code>plant</code> is written in C++ for speed, with an interface (binding) to R for interactive analyses. This means that <code>plant</code> follows an Object Oriented design (OO). The structure of <code>plant</code> objects are defined by classes which provide a set of properties and functions (methods?) that are common to all objects of the same type.</p>
<p>An important feature of (OO) is the ‘inheritance’ of classes. This allows us to implement our models as specialisations of a general case. For example, all bespoke <code>plant</code> models can (and will) inherit the general Strategy class. This provides the base set of properties and methods the solver requires without having to re-invent the wheel (and saving us a lot of repeated work).</p>
<p>Because we rely on this pattern of inheriting base properties, it is useful to review several key <code>plant</code> classes, even though we might only change one or two.</p>
<div id="individual" class="section level4">
<h4 class="hasAnchor">
<a href="#individual" class="anchor"></a>Individual</h4>
<p>Represents an individual</p>
</div>
<div id="cohort" class="section level4">
<h4 class="hasAnchor">
<a href="#cohort" class="anchor"></a>Cohort</h4>
<p>Represents individuals of a similar age</p>
</div>
<div id="environment" class="section level4">
<h4 class="hasAnchor">
<a href="#environment" class="anchor"></a>Environment**</h4>
<p>Defines environmental conditions</p>
</div>
<div id="patch" class="section level4">
<h4 class="hasAnchor">
<a href="#patch" class="anchor"></a>Patch</h4>
<p>A patch hosting many cohorts, of many individuals, all interacting with the environment</p>
</div>
<div id="schedule" class="section level4">
<h4 class="hasAnchor">
<a href="#schedule" class="anchor"></a>Schedule</h4>
<p>The times at which cohorts of different species are introduced in a patch</p>
</div>
<div id="species" class="section level4">
<h4 class="hasAnchor">
<a href="#species" class="anchor"></a>Species</h4>
<p>Defines the attributes of groups of individuals</p>
</div>
<div id="parameters" class="section level4">
<h4 class="hasAnchor">
<a href="#parameters" class="anchor"></a>Parameters</h4>
<p>Settings of species, patches and environment</p>
</div>
<div id="strategy" class="section level4">
<h4 class="hasAnchor">
<a href="#strategy" class="anchor"></a>Strategy**</h4>
<p>The processes that determine species’ characteristics such as growth, death and reproduction, including competitive interactions.</p>
</div>
<div id="adaptiveinterpolator" class="section level4">
<h4 class="hasAnchor">
<a href="#adaptiveinterpolator" class="anchor"></a>AdaptiveInterpolator</h4>
<p>Maps a gradient of environmental conditions onto a monotonic spline bounded between (0, 1) to simplify the calculation of competitive interactions.</p>
</div>
<div id="scm" class="section level4">
<h4 class="hasAnchor">
<a href="#scm" class="anchor"></a>SCM</h4>
<p>Solves for the trajectories of different cohorts along all defined characteristics.</p>
<p>*<em>When developing your own strategy, you’ll likely only need to create a Strategy and an Environment</em></p>
</div>
</div>
<div id="r-interface" class="section level2">
<h2 class="hasAnchor">
<a href="#r-interface" class="anchor"></a>R Interface</h2>
<p>The C++ framework provides a fast and powerful implementation of the SCM solver, but we anticipate that many users will prefer to interact with their models through a more familiar language like R.</p>
<p><code>plant</code> currently includes an R-to-C++ binding using two R libraries: Rcpp and RcppR6</p>
<div id="rcpp" class="section level4">
<h4 class="hasAnchor">
<a href="#rcpp" class="anchor"></a>Rcpp</h4>
<p>Rcpp is a (very) popular library that maps R types to C++ objects, and <em>vice versa</em>. This allows authors to wrap C++ code as functions that can be used within their R package.</p>
</div>
<div id="rcppr6" class="section level4">
<h4 class="hasAnchor">
<a href="#rcppr6" class="anchor"></a>RcppR6</h4>
<p>An extension of Rcpp is the library RcppR6, which maps a specific R type, the R6 class, to complex C++ objects like the <code>plant</code> SCM solver.</p>
<p>R6 classes differ from normal R types (i.e. S3, S4) in that methods (functions) belong to objects of a given class, rather than existing as generic objects themselves. This means that a given plant object <code>p</code> has specific methods available as <code>p$method()</code> (rather than <code>method(p)</code>).</p>
<p>The other quirk of R6 classes is that they use reference semantics. This means that the state of R6 objects (derived from an R6 class) can be changed in place (i.e. without re-assignment).</p>
<pre><code># S3 example: p_new != p_old
p_new &lt;- method(p_old)

# R6 example: p == p_new
p$method()
</code></pre>
<p>RcppR6 is a good match for <code>scm</code> objects which have many layers of properties and methods (see above), but also maintains a natural concept of state.</p>
<p>The binding between RcppR6 and C++ is handled in a RcppR6_classes.yml file. Here we define which of the <code>plant</code> classes we would like to access from R and which properties and methods we would like in our interface. Again, most of this is general and only a few classes will need specialisation when implementing a new <code>plant</code> model.</p>
</div>
<div id="build-tools" class="section level3">
<h3 class="hasAnchor">
<a href="#build-tools" class="anchor"></a>Build tools</h3>
<p>Lastly, we need to compile C++ whenever we edit it. Both the R interface and the C++ library can be compiled using <code><a href="https://devtools.r-lib.org//reference/load_all.html">devtools::load_all()</a></code> which calls a build step described in the <code>makefile</code>.</p>
<div id="make" class="section level4">
<h4 class="hasAnchor">
<a href="#make" class="anchor"></a>make</h4>
<p>Occasionally, we need to interact with make directly, for example when recompiling the RcppR6 classes.</p>
<pre><code>make clean

make RcppR6</code></pre>
</div>
</div>
<div id="testthat" class="section level3">
<h3 class="hasAnchor">
<a href="#testthat" class="anchor"></a>testthat</h3>
<p>A test suite is included on the R side using the <code>testthat</code> library. <code><a href="https://devtools.r-lib.org//reference/test.html">devtools::test()</a></code> will test both the RcppR6 integration, the C++ numerical routines and specific models. A test framework aims to prevent regressions, such as breaking one feature by introducing another, so we may like to add tests for our model once we have finished.</p>
<p>It is good practice to run the tests <strong>before</strong> working with your model.</p>
</div>
</div>
</div>
<div id="implementing-kohyama-1993" class="section level1">
<h1 class="hasAnchor">
<a href="#implementing-kohyama-1993" class="anchor"></a>Implementing Kohyama 1993</h1>
<p>Growth, reproduction, mortality related to basal area.</p>
<div id="model-structure" class="section level2">
<h2 class="hasAnchor">
<a href="#model-structure" class="anchor"></a>Model structure</h2>
<div id="size-structured-competition" class="section level3">
<h3 class="hasAnchor">
<a href="#size-structured-competition" class="anchor"></a>Size structured competition</h3>
<p><strong>Eq. 8</strong> <span class="math display">\[
B(t, a, x) = \frac{\pi}{4 \cdot s(t, a)} \int_{x}^{x_{max}} y^2 \cdot f(t, a, y) dy
\]</span></p>
<p><em>added additional smoothing parameter to interpolate competitive effect using a continuous function. <span class="math inline">\(\eta = 12.0\)</span></em></p>
</div>
<div id="growth" class="section level3">
<h3 class="hasAnchor">
<a href="#growth" class="anchor"></a>Growth</h3>
<p><strong>Eq. 10</strong> <span class="math display">\[
G(t, a, x) = x \cdot \Bigg(b_0 - b_1 \cdot ln{x} - b_2 \cdot B(t, a, x)\Bigg)
\]</span></p>
</div>
<div id="fecundity" class="section level3">
<h3 class="hasAnchor">
<a href="#fecundity" class="anchor"></a>Fecundity</h3>
<p><strong>Eq. 12</strong></p>
<p><span class="math display">\[
R(t, a, x0) = d_0 \cdot B_0 \cdot exp{-d_1 \cdot B(t, a, x_0)}
\]</span></p>
<p><em><span class="math inline">\(B_0\)</span> re-interpreted as an individual basal area, integrated over whole stand, providing equivalent total reproductive output as Eq 9.</em></p>
</div>
<div id="mortality" class="section level3">
<h3 class="hasAnchor">
<a href="#mortality" class="anchor"></a>Mortality</h3>
<p><strong>Eq. 11</strong> <span class="math display">\[
\mu(t, a, x) = - c_0 + c_1 \cdot B(t, a, x_0)
\]</span></p>
<p><em>Growth independent mortality provided by disturbance regime</em></p>
</div>
<div id="dispersal-and-establishment" class="section level3">
<h3 class="hasAnchor">
<a href="#dispersal-and-establishment" class="anchor"></a>Dispersal and establishment</h3>
<p>Dispersal and establishment are fixtures of the <code>plant</code> framework, but not used in the original formulation of Kohyama. We set them both to <span class="math inline">\(1.0\)</span>.</p>
</div>
</div>
<div id="adding-a-new-plant-strategy" class="section level2">
<h2 class="hasAnchor">
<a href="#adding-a-new-plant-strategy" class="anchor"></a>Adding a new <code>plant</code> strategy</h2>
<div id="choose-a-name" class="section level3">
<h3 class="hasAnchor">
<a href="#choose-a-name" class="anchor"></a>0. Choose a name</h3>
<p><em>“As a naming convention, strategies are named using two initials (eg. the first two authors) followed by a year, e.g. FF16. A single letter suffix can be added to indicate a minor modification of an existing strategy, e.g. FF16r”</em></p>
<p><a href="https://traitecoevo.github.io/plant/articles/developer_notes.html">Developer Notes</a></p>
</div>
<div id="use-scaffolder-to-create-template-files" class="section level3">
<h3 class="hasAnchor">
<a href="#use-scaffolder-to-create-template-files" class="anchor"></a>1. Use scaffolder to create template files</h3>
<pre><code><a href="https://rdrr.io/r/base/source.html">source('inst/scripts/new_strategy_scaffolder.R')
create_strategy_scaffold("K93", "FF16")</a></code></pre>
<p>Three important files</p>
<ul>
<li>K93_strategy.h</li>
<li>K93_strategy.cpp</li>
<li>K93_environment.h</li>
</ul>
</div>
<div id="add-growth-mortality-and-reproduction" class="section level3">
<h3 class="hasAnchor">
<a href="#add-growth-mortality-and-reproduction" class="anchor"></a>1. Add growth, mortality and reproduction</h3>
<p>In <code>K93_strategy.cpp</code> add:</p>
<pre class="{c++}"><code>// [eqn 10] Growth
double K93_Strategy::size_dt(double size,
                             double cumulative_basal_area) const {

  double growth = size * (b_0 - b_1 * log(size) - b_2 * cumulative_basal_area);

  if(growth &lt; 0.0) {
    growth = 0.0;
  }

  return growth;
}

// [eqn 12] Reproduction
double K93_Strategy::fecundity_dt(double size,
                                  double cumulative_basal_area) const {
  double basal_area = size_to_basal_area(size);
  return d_0 * basal_area * exp(-d_1 * cumulative_basal_area);
}

// [eqn 11] Mortality
double K93_Strategy::mortality_dt(double cumulative_basal_area,
                                  double cumulative_mortality) const {
  // If mortality probability is 1 (latency = Inf) then the rate
  // calculations break.  Setting them to zero gives the correct
  // behaviour.
  if (R_FINITE(cumulative_mortality)) {
    double mu = -c_0 + c_1 * cumulative_basal_area;
    return (mu &gt; 0)? mu:0.0;
 } else {
    return 0.0;
  }
}</code></pre>
</div>
<div id="map-competition-to-environment" class="section level3">
<h3 class="hasAnchor">
<a href="#map-competition-to-environment" class="anchor"></a>1. Map competition to environment</h3>
<p>In <code>K93_strategy.cpp</code></p>
<pre class="{c++}"><code>double K93_Strategy::size_to_basal_area(double size) const {
  return M_PI / 4 * pow(size, 2);
}

double K93_Strategy::compute_competition(double z, double size) const {

  // Competition only felt if plant bigger than target size z
  return size_to_basal_area(size) * Q(z, size);
 };</code></pre>
<p>This does a round-about-trip to <code>K93_environment.h</code>:</p>
<pre class="{c++}"><code>void compute_environment(Function f_compute_competition, double height_max) {
  const double lower_bound = 0.0;
  double upper_bound = height_max;

  auto f_canopy_openness = [&amp;] (double height) -&gt; double {return exp(-k_I * f_compute_competition(height));};
  environment_interpolator =
    environment_generator.construct(f_canopy_openness, lower_bound, upper_bound);
}</code></pre>
<p>which maps basal area onto a spline between (0, 1).</p>
</div>
<div id="integrate-into-rates-function" class="section level3">
<h3 class="hasAnchor">
<a href="#integrate-into-rates-function" class="anchor"></a>1. Integrate into rates function</h3>
<p>Back transform environment interpolator so that smallest individual experience largest competitive effect</p>
<pre class="{c++}"><code>  // i.e. setting rates of ode vars from the state and updating aux vars
  void K93_Strategy::compute_rates(const K93_Environment&amp; environment,
                                bool reuse_intervals,
                                Internals&amp; vars) {

    double height = vars.state(HEIGHT_INDEX);

    // suppression integral mapped [0, 1] using adaptive spline
    // back transform to basal area and add suppression from self
    double competition = environment.get_environment_at_height(height);
    double basal_area = size_to_basal_area(height);

    double cumulative_basal_area = -log(competition) / environment.k_I;

    if (!util::is_finite(cumulative_basal_area)) {
      util::stop("Environmental interpolation out of bounds");
    }</code></pre>
<p>Then calculate impact on growth:</p>
<pre class="{c++}"><code>    vars.set_rate(HEIGHT_INDEX,
      size_dt(height, cumulative_basal_area));

    vars.set_rate(FECUNDITY_INDEX,
      fecundity_dt(height, cumulative_basal_area));

    vars.set_rate(MORTALITY_INDEX,
      mortality_dt(cumulative_basal_area, vars.state(MORTALITY_INDEX)));
  }</code></pre>
</div>
<div id="declare-model-methods-in-header-file" class="section level3">
<h3 class="hasAnchor">
<a href="#declare-model-methods-in-header-file" class="anchor"></a>1. Declare model methods in header file</h3>
<p>C++ keeps track of method declarations in a header file.</p>
<p>In <code>K93_strategy.h</code> the structure of our new class begins with:</p>
<pre class="{c++}"><code>class K93_Strategy: public Strategy&lt;K93_Environment&gt; {
public:
  typedef std::shared_ptr&lt;K93_Strategy&gt; ptr;
  K93_Strategy();

  ...

  void update_dependent_aux(const int index, Internals&amp; vars);</code></pre>
<p>the abbreviated section describing the naming and maintenance of characteristic indices.</p>
<p>There are two special methods that must be defined:</p>
<pre class="{c++}"><code>  void compute_rates(const K93_Environment&amp; environment,
                     bool reuse_intervals,
                     Internals&amp; vars);

  double compute_competition(double z, double size) const;</code></pre>
<p>Our parameters</p>
<pre class="{c++}"><code>  // K93 Parameters  -------------------------------------------
  // Initial seedling size (dbh cm)
  double height_0;

  // * Growth
  // Growth intercept (yr-1)
  double b_0;
  // Growth asymptote (yr-1.(ln cm)-1)
  double b_1;
  // Growth suppression rate (m2.cm-2.yr-1)
  double b_2;


  // * Reproduction
  // Recruitment rate (cm2.yr-1)
  double d_0;
  // Reduction from suppression (m2.cm-2.yr-1)
  double d_1;

  // * Mortality
  // Intercept (yr-1)
  double c_0;
  // Suppression rate (m2.cm-2.yr-1)
  double c_1;</code></pre>
<p>Now our method arguments:</p>
<pre class="{c++}"><code>  // K93 Methods  ----------------------------------------------
  double size_to_basal_area(double size) const;

  // Growth rate of a plant per unit time:
  double size_dt(double size, double cumulative_basal_area) const;

  // Rate of offspring production
  double fecundity_dt(double size, double cumulative_basal_area) const;

  // Rate of mortality over time
  double mortality_dt(double cumulative_basal_area,
                      double cumulative_mortality) const;
</code></pre>
<p>We have some nuisance parameters for dispersal, establishment and smoothing</p>
<pre class="{c++}"><code>  // Probability of survival during dispersal
  // required by scm.h
  double S_D = 1.0;

  // Smoothing parameter
  double eta = 12;

  double K93_Strategy::establishment_probability(const K93_Environment&amp; environment){
    //TODO: may want to make this dependent on achieving positive growth rate
    return 1.0;
  }

  // Smoothing function for competition effect
  double K93_Strategy::Q(double z, double size) const {
    if (z &gt; size) {
      return 0.0;
    }
    const double tmp = 1.0 - pow(z / size, eta);

    return tmp * tmp;
  }</code></pre>
<p>Finally, the K93_Strategy class ends with:</p>
<pre class="{c++}"><code>  // Set constants within K93_Strategy
  void prepare_strategy();

  std::string name;
};</code></pre>
<p>and a pointer.</p>
</div>
<div id="add-to-rcppr6-yml" class="section level3">
<h3 class="hasAnchor">
<a href="#add-to-rcppr6-yml" class="anchor"></a>1. Add to RcppR6.yml</h3>
<p>Section already added by scaffolder, need to adapt to method names.</p>
<pre><code># The following strategy was built from FF16r on Wed Aug 12 15:33:08 2020
K93_Strategy:
  name_cpp: "plant::K93_Strategy"
  roxygen: |
    Strategy parameters that tune various aspects of the biological model.
    @title Strategy parameters
    @param ...,values Values to initialise the struct with (either as
    variadic arguments, or as a list, but not both).
    @export
  list:
    - height_0: double
    - b_0: double
    - b_1: double
    - b_2: double
    - c_0: double
    - c_1: double
    - d_0: double
    - d_1: double
    - control: "plant::Control"</code></pre>
<p><code>K93_Environment</code> also created, but no changes needed.</p>
</div>
<div id="expose-new-strategy-to-r" class="section level3">
<h3 class="hasAnchor">
<a href="#expose-new-strategy-to-r" class="anchor"></a>1. Expose new strategy to R</h3>
<p>In <code>K93.R</code></p>
<pre><code>##' Hyperparameters for K93 physiological model
##' @title Hyperparameters for K93 physiological model
##' @export
##' @rdname K93_hyperpar
make_K93_hyperpar &lt;- function(
        b_0 = 0.059,    # Growth intercept year-1
        b_1 = 0.012,    # Growth asymptote year-1.(ln cm)-1
        b_2 = 0.00041,  # Growth suppression rate m2.cm-2.year-1
        c_0 = 0.008,    # Mortality intercept year-1
        c_1 = 0.00044,  # Mortality suppression rate m2.cm-2.year-1
        d_0 = 0.00073,  # Recruitment rate (cm2.year-1)
        d_1 = 0.044    # Recruitment suppression rate (m2.cm-2)
  ) {
  assert_scalar &lt;- function(x, name=deparse(substitute(x))) {
    if (length(x) != 1L) {
      stop(sprintf("%s must be a scalar", name), call. = FALSE)
    }
  }

  assert_scalar(b_0)
  assert_scalar(b_1)
  assert_scalar(b_2)
  assert_scalar(c_0)
  assert_scalar(c_1)
  assert_scalar(d_0)
  assert_scalar(d_1)

  function(m, s, filter=TRUE) {
    with_default &lt;- function(name, default_value=s[[name]]) {
      rep_len(if (name %in% colnames(m)) m[, name] else default_value,
              nrow(m))
    }

    m
  }

}
</code></pre>
<p>Add tests to <code>test-strategy-k93.R</code></p>
</div>
<div id="build-and-run" class="section level3">
<h3 class="hasAnchor">
<a href="#build-and-run" class="anchor"></a>1. Build and run</h3>
<pre><code>make clean
make RcppR6</code></pre>
<p>Then <code><a href="https://devtools.r-lib.org//reference/load_all.html">devtools::load_all(".")</a></code></p>
<pre><code># Patches of competing plants
p0 &lt;- scm_base_parameters("K93")
p1 &lt;- expand_parameters(trait_matrix(0.0825, "b_0"), p = p0, mutant = FALSE)
p1$seed_rain &lt;- 20

data1 &lt;- run_scm_collect(p1)

matplot(data1$time, data1$species[[1]]["height", , ],
        lty=1, col=make_transparent("black", 0.25), type="l",
        las=1, xlab="Time (years)", ylab="Height (m)")</code></pre>
<p>We changed disturbance from 30 to 200 yrs.</p>
<!-- ## Exploring results
compare plant vs graphs in paper
  - age, size density distn
  - see: plant paper for size dstn -->
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Daniel Falster, Richard FitzJohn, Rafael Schouten, Andrew O'Reilly-Nugent.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
