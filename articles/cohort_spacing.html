<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cohort spacing algorithm • plant</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<script src="../extra.js"></script><meta property="og:title" content="Cohort spacing algorithm">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">plant</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
    Home
  </a>
</li>
<li>
  <a href="../articles/plant.html">
    <span class="fa fa-tree"></span>
     
    Getting Started
  </a>
</li>
<li>
  <a href="../reference/index.html">
    <span class="fa fa-list"></span>
     
    Reference
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-book"></span>
     
    Theory
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/demography.html">Demography of plants, patches, and metacommunities</a>
    </li>
    <li>
      <a href="../articles/physiology.html">The FF16 strategy</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-file-code-o"></span>
     
    Examples
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/individuals.html">Individual plants</a>
    </li>
    <li>
      <a href="../articles/patch.html">Patches of competing plants</a>
    </li>
    <li>
      <a href="../articles/equilibrium.html">Finding demographic equilibrium</a>
    </li>
    <li>
      <a href="../articles/emergent.html">Emergent properties of patches</a>
    </li>
    <li>
      <a href="../articles/fitness.html">Calculating fitness</a>
    </li>
    <li>
      <a href="../articles/cohort_spacing.html">The cohort spacing algorithm</a>
    </li>
    <li>
      <a href="../articles/parameters.html">Changing parameters</a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/developer_notes.html">
    <span class="fa fa-terminal"></span>
     
    Developer Notes
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="../news/index.html">
    <span class="fa fa-newspaper-o"></span>
     
    News
  </a>
</li>
<li>
  <a href="https://github.com/traitecoevo/plant">
    <span class="fa fa-github fa-lg"></span>
     
    Github
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Cohort spacing algorithm</h1>
                        <h4 class="author">Rich FitzJohn</h4>
                        <h4 class="author">Daniel Falster</h4>
            
            <h4 class="date">2016</h4>
      
      <small>Source: <a href="https:/github.com/traitecoevo/plant/blob/master/vignettes/cohort_spacing.Rmd"><code>vignettes/cohort_spacing.Rmd</code></a></small>

    </div>

    
    
<div class="contents">
<p>This vignette shows some details of cohort splitting. It’s probably not very interesting to most people, only those interested in knowing how the SCM technique works in detail. It also uses a lot of non-exported, non-documented functions from plant so you’ll see a lot of <code>plant:::</code> prefixes.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(plant)
<span class="kw">library</span>(parallel)

p0 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/scm_base_parameters.html">scm_base_parameters</a></span>(<span class="st">"FF16"</span>)
p &lt;-<span class="st"> </span><span class="kw"><a href="../reference/expand_parameters.html">expand_parameters</a></span>(<span class="kw"><a href="../reference/trait_matrix.html">trait_matrix</a></span>(<span class="fl">0.0825</span>, <span class="st">"lma"</span>), p0, <span class="ot">FALSE</span>)
p$seed_rain &lt;-<span class="st"> </span><span class="dv">20</span> <span class="co"># close to equilibrium</span></code></pre>
<p>The default cohort introduction times are designed to concentrate cohort introductions onto earlier times, based on empirical patterns of cohort refining:</p>
<pre class="sourceCode r"><code class="sourceCode r">t1 &lt;-<span class="st"> </span>p$cohort_schedule_times[[<span class="dv">1</span>]]
<span class="kw">plot</span>(t1, <span class="dt">cex=</span>.<span class="dv">2</span>, <span class="dt">pch=</span><span class="dv">19</span>, <span class="dt">ylab=</span><span class="st">"Time (years)"</span>, <span class="dt">las=</span><span class="dv">1</span>)</code></pre>
<div class="figure">
<img src="figure/cohort_spacing__unnamed-chunk-2-1.png">
</div>
<p>The actual differences are stepped in order to increase the chance that cohorts from different species will be introduced at the same time and reduce the total amount of work being done.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(<span class="kw">diff</span>(t1), <span class="dt">log=</span><span class="st">"y"</span>, <span class="dt">pch=</span><span class="dv">19</span>, <span class="dt">cex=</span>.<span class="dv">2</span>,
     <span class="dt">ylab=</span><span class="st">"Time difference (years)"</span>, <span class="dt">las=</span><span class="dv">1</span>)</code></pre>
<div class="figure">
<img src="figure/cohort_spacing__unnamed-chunk-3-1.png">
</div>
<p>We can create more refined schedules by interleaving points between these points:</p>
<pre class="sourceCode r"><code class="sourceCode r">interleave &lt;-<span class="st"> </span>function(x) {
  n &lt;-<span class="st"> </span><span class="kw">length</span>(x)
  xp &lt;-<span class="st"> </span><span class="kw">c</span>(x[-n] +<span class="st"> </span><span class="kw">diff</span>(x) /<span class="st"> </span><span class="dv">2</span>, <span class="ot">NA</span>)
  <span class="kw">c</span>(<span class="kw">rbind</span>(x, xp))[-<span class="st"> </span><span class="dv">2</span> *<span class="st"> </span>n]
}

t2 &lt;-<span class="st"> </span><span class="kw">interleave</span>(t1)
t3 &lt;-<span class="st"> </span><span class="kw">interleave</span>(t2)</code></pre>
<p>Consider running the SCM and computing seed rain at the end; this is one of the key outputs from the model so a reasonable one to look for differences in.</p>
<pre class="sourceCode r"><code class="sourceCode r">run_with_times &lt;-<span class="st"> </span>function(p, t) {
  p$cohort_schedule_times[[<span class="dv">1</span>]] &lt;-<span class="st"> </span>t
  <span class="kw"><a href="../reference/run_scm.html">run_scm</a></span>(p)$seed_rains
}

sr_1 &lt;-<span class="st"> </span><span class="kw">run_with_times</span>(p, t1)
sr_2 &lt;-<span class="st"> </span><span class="kw">run_with_times</span>(p, t2)
sr_3 &lt;-<span class="st"> </span><span class="kw">run_with_times</span>(p, t3)</code></pre>
<p>Seed rain increases as cohorts are introduced more finely, though at a potentially saturating rate. We’re doing lots more work at the more refined end!</p>
<pre class="sourceCode r"><code class="sourceCode r">sr &lt;-<span class="st"> </span><span class="kw">c</span>(sr_1, sr_2, sr_3)
sr</code></pre>
<pre><code>## [1] 16.88934 16.87365 17.10484</code></pre>
<p>The differences in seed rain are not actually that striking (perhaps 1%) but in some runs can be more, and the <em>variation</em> creates instabilities.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(<span class="kw">c</span>(<span class="kw">length</span>(t1), <span class="kw">length</span>(t2), <span class="kw">length</span>(t3)), sr,
     <span class="dt">las=</span><span class="dv">1</span>, <span class="dt">xlab=</span><span class="st">"Number of cohort introductions"</span>, <span class="dt">ylab=</span><span class="st">"Seed rain"</span>)</code></pre>
<div class="figure">
<img src="figure/cohort_spacing__unnamed-chunk-7-1.png">
</div>
<p>Where is the fitness difference coming from?</p>
<p>Consider adding a <em>single</em> additional cohort at one of the points along the first vector of times <code>t1</code> and computing fitness:</p>
<pre class="sourceCode r"><code class="sourceCode r">insert_time &lt;-<span class="st"> </span>function(i, x) {
  j &lt;-<span class="st"> </span><span class="kw">seq_len</span>(i)
  <span class="kw">c</span>(x[j], (x[i] +<span class="st"> </span>x[i<span class="dv">+1</span>])/<span class="dv">2</span>, x[-j])
}
run_with_insert &lt;-<span class="st"> </span>function(i, p, t) {
  <span class="kw">run_with_times</span>(p, <span class="kw">insert_time</span>(i, t))
}</code></pre>
<p>The internal function <code>plant:::run_scm_error</code> runs the SCM and computes errors as the integration proceeds; this helps shed some light.</p>
<pre class="sourceCode r"><code class="sourceCode r">i &lt;-<span class="st"> </span><span class="kw">seq_len</span>(<span class="kw">length</span>(t1) -<span class="st"> </span><span class="dv">1</span>)
res &lt;-<span class="st"> </span><span class="kw">unlist</span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/parallel/topics/mclapply">mclapply</a></span>(i, run_with_insert, p, t1))
tm &lt;-<span class="st"> </span>(t1[-1L] +<span class="st"> </span>t1[-<span class="kw">length</span>(t1)]) /<span class="st"> </span><span class="dv">2</span></code></pre>
<p>The biggest deviations in output seed rain come about half way through the schedule:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(i, res -<span class="st"> </span>sr_1, <span class="dt">xlab=</span><span class="st">"Index"</span>, <span class="dt">ylab=</span><span class="st">"Seed rain"</span>, <span class="dt">las=</span><span class="dv">1</span>)
<span class="kw">abline</span>(<span class="dt">h=</span><span class="dv">0</span>, <span class="dt">col=</span><span class="st">"grey"</span>)</code></pre>
<div class="figure">
<img src="figure/cohort_spacing__unnamed-chunk-10-1.png">
</div>
<p>Though because of the compression of early times it’s still fairly early:</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(tm, res -<span class="st"> </span>sr_1, <span class="dt">xlab=</span><span class="st">"Time (years)"</span>, <span class="dt">ylab=</span><span class="st">"Seed rain"</span>, <span class="dt">las=</span><span class="dv">1</span>)
<span class="kw">abline</span>(<span class="dt">h=</span><span class="dv">0</span>, <span class="dt">col=</span><span class="st">"grey"</span>)</code></pre>
<div class="figure">
<img src="figure/cohort_spacing__unnamed-chunk-11-1.png">
</div>
<pre class="sourceCode r"><code class="sourceCode r">ebt &lt;-<span class="st"> </span>plant:::<span class="kw"><a href="../reference/FF16.html">FF16_SCM</a></span>(p)
ebt$<span class="kw">run</span>()</code></pre>
<p>Now look at the contribution of different cohorts to see rain (x axis log scaled for clarity). In this case almost all the contribution comes from early cohorts (this is essentially a single-age stand of pioneers). Overlaid on this are the five cohorts with the largest change in total fitness (biggest difference in red). The difference is not coming from seed rain contributions from those cohorts, which is basically zero, though it is higher than the surrounding cohorts.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(t1[-<span class="dv">1</span>], ebt$<span class="kw">seed_rain_cohort</span>(<span class="dv">1</span>)[-<span class="dv">1</span>], <span class="dt">log=</span><span class="st">"xy"</span>,
     <span class="dt">xlab=</span><span class="st">"Time (years)"</span>, <span class="dt">ylab=</span><span class="st">"Seed rain"</span>)
j &lt;-<span class="st"> </span><span class="kw">order</span>(<span class="kw">abs</span>(res -<span class="st"> </span>sr_1), <span class="dt">decreasing=</span><span class="ot">TRUE</span>)[<span class="dv">1</span>:<span class="dv">5</span>]
<span class="kw">abline</span>(<span class="dt">v=</span>tm[j], <span class="dt">col=</span><span class="kw">c</span>(<span class="st">"red"</span>, <span class="kw">rep</span>(<span class="st">"grey"</span>, <span class="dv">4</span>)))</code></pre>
<div class="figure">
<img src="figure/cohort_spacing__unnamed-chunk-12-1.png">
</div>
<p>Next up, need to work out what the fitness contribution of each cohort is.</p>
<pre class="sourceCode r"><code class="sourceCode r">dat1 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/run_scm_collect.html">run_scm_collect</a></span>(p)
p2 &lt;-<span class="st"> </span>p
p2$cohort_schedule_times[[<span class="dv">1</span>]] &lt;-<span class="st"> </span><span class="kw">insert_time</span>(j[[<span class="dv">1</span>]], t1)
dat2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/run_scm_collect.html">run_scm_collect</a></span>(p2)</code></pre>
<p>Then consider the light environment over time. This reconstructs the spline for the light environment for both runs, and computes canopy openness in both and computes the difference in light environments. The resulting image plot is blue in regions where the refined light environment is lighter (higher canopy openness) and red in regions where the the light environment is darker in the refined environment.</p>
<pre class="sourceCode r"><code class="sourceCode r">f &lt;-<span class="st"> </span>function(e, h) {
  i &lt;-<span class="st"> </span>plant:::<span class="kw"><a href="../reference/Interpolator.html">Interpolator</a></span>()
  i$<span class="kw">init</span>(e[, <span class="dv">1</span>], e[, <span class="dv">2</span>])
  y &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="dv">1</span>, <span class="kw">length</span>(h))
  j &lt;-<span class="st"> </span>h &lt;<span class="st"> </span>i$max
  y[j] &lt;-<span class="st"> </span>i$<span class="kw">eval</span>(h[j])
  y
}
hmax &lt;-<span class="st"> </span><span class="kw">max</span>(dat1$light_env[[<span class="kw">length</span>(dat1$light_env)]][, <span class="st">"height"</span>])
h &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>, hmax, <span class="dt">length.out=</span><span class="dv">201</span>)
y1 &lt;-<span class="st"> </span><span class="kw">sapply</span>(dat1$light_env, f, h)
y2 &lt;-<span class="st"> </span><span class="kw">sapply</span>(dat2$light_env, f, h)[, -(j[[<span class="dv">1</span>]] +<span class="st"> </span>1L)]
dy &lt;-<span class="st"> </span><span class="kw">t</span>(y2 -<span class="st"> </span>y1)
dy[<span class="kw">abs</span>(dy) &lt;<span class="st"> </span><span class="fl">1e-10</span>] &lt;-<span class="st"> </span><span class="ot">NA</span></code></pre>
<p>ColorBrewer’s RdBu</p>
<pre class="sourceCode r"><code class="sourceCode r">cols &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"#B2182B"</span>, <span class="st">"#D6604D"</span>, <span class="st">"#F4A582"</span>, <span class="st">"#FDDBC7"</span>,
          <span class="st">"#D1E5F0"</span>, <span class="st">"#92C5DE"</span>, <span class="st">"#4393C3"</span>, <span class="st">"#2166AC"</span>)
pal &lt;-<span class="st"> </span><span class="kw">colorRampPalette</span>(cols)(<span class="dv">20</span>)
<span class="kw">image</span>(dat1$time, h, dy, <span class="dt">xlab=</span><span class="st">"Time (years)"</span>, <span class="dt">ylab=</span><span class="st">"Height (m)"</span>, <span class="dt">las=</span><span class="dv">1</span>,
      <span class="dt">col=</span>pal)</code></pre>
<div class="figure">
<img src="figure/cohort_spacing__unnamed-chunk-15-1.png">
</div>
<p>Because the differences are mostly manifest in the leaf area, we monitor error in both the leaf area and in fitness for all cohorts: (black line indicates the cohort identified as problematic above)</p>
<pre class="sourceCode r"><code class="sourceCode r">dat &lt;-<span class="st"> </span>plant:::<span class="kw">run_scm_error</span>(p)
<span class="kw">image</span>(dat1$time, dat1$time, dat$err$lai[[<span class="dv">1</span>]],
      <span class="dt">xlab=</span><span class="st">"Patch age (years)"</span>, <span class="dt">ylab=</span><span class="st">"Introduction time (years)"</span>, <span class="dt">las=</span><span class="dv">1</span>)
<span class="kw">abline</span>(<span class="dt">h=</span>t1[j[[<span class="dv">1</span>]]])</code></pre>
<div class="figure">
<img src="figure/cohort_spacing__unnamed-chunk-16-1.png">
</div>
<p>We then run through rounds of refining cohorts until estimated error has decreased down to an appropriate threshold:</p>
<pre class="sourceCode r"><code class="sourceCode r">p_refined &lt;-<span class="st"> </span><span class="kw"><a href="../reference/build_schedule.html">build_schedule</a></span>(p)
sr_refined &lt;-<span class="st"> </span><span class="kw">attr</span>(p_refined, <span class="st">"seed_rain_out"</span>)</code></pre>
<p>Each round, the algorithm looks at the error in the leaf area calculations and in the fitness calculations and refines the worst cohorts, repeating as necessary.</p>
<pre class="sourceCode r"><code class="sourceCode r">t_refined &lt;-<span class="st"> </span>p_refined$cohort_schedule_times[[<span class="dv">1</span>]]
i &lt;-<span class="st"> </span><span class="kw">seq_len</span>(<span class="kw">length</span>(t_refined) -<span class="st"> </span><span class="dv">1</span>)
res &lt;-<span class="st"> </span><span class="kw">unlist</span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/parallel/topics/mclapply">mclapply</a></span>(i, run_with_insert, p_refined, t_refined))

tm &lt;-<span class="st"> </span>(t1[-1L] +<span class="st"> </span>t1[-<span class="kw">length</span>(t1)]) /<span class="st"> </span><span class="dv">2</span></code></pre>
<p>The problem cohorts are still in about the same place, but are much less pronounced (and less so if considering relative error)</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(i, res -<span class="st"> </span>sr_refined, <span class="dt">xlab=</span><span class="st">"Index"</span>, <span class="dt">ylab=</span><span class="st">"Seed rain"</span>, <span class="dt">las=</span><span class="dv">1</span>)
<span class="kw">abline</span>(<span class="dt">h=</span><span class="dv">0</span>, <span class="dt">col=</span><span class="st">"grey"</span>)</code></pre>
<div class="figure">
<img src="figure/cohort_spacing__unnamed-chunk-19-1.png">
</div>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(i, res /<span class="st"> </span>sr_refined -<span class="st"> </span><span class="dv">1</span>, <span class="dt">xlab=</span><span class="st">"Index"</span>, <span class="dt">ylab=</span><span class="st">"Seed rain"</span>, <span class="dt">las=</span><span class="dv">1</span>)</code></pre>
<div class="figure">
<img src="figure/cohort_spacing__unnamed-chunk-19-2.png">
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Daniel Falster, Richard FitzJohn.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
