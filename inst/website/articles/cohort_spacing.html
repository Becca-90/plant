<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cohort spacing algorithm • plant</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<script src="../extra.js"></script><meta property="og:title" content="Cohort spacing algorithm">
<meta property="og:description" content="plant">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">plant</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.0.</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home"></span>
     
    Home
  </a>
</li>
<li>
  <a href="../articles/plant.html">
    <span class="fas fa-tree"></span>
     
    Getting Started
  </a>
</li>
<li>
  <a href="../reference/index.html">
    <span class="fas fa-list"></span>
     
    Reference
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fas fa-book"></span>
     
    Theory
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/demography.html">Demography of plants, patches, and metacommunities</a>
    </li>
    <li>
      <a href="../articles/physiology.html">The FF16 strategy</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fas fa-file-code-o"></span>
     
    Examples
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/individuals.html">Individual plants</a>
    </li>
    <li>
      <a href="../articles/patch.html">Patches of competing plants</a>
    </li>
    <li>
      <a href="../articles/equilibrium.html">Finding demographic equilibrium</a>
    </li>
    <li>
      <a href="../articles/emergent.html">Emergent properties of patches</a>
    </li>
    <li>
      <a href="../articles/fitness.html">Calculating fitness</a>
    </li>
    <li>
      <a href="../articles/cohort_spacing.html">The cohort spacing algorithm</a>
    </li>
    <li>
      <a href="../articles/parameters.html">Changing parameters</a>
    </li>
    <li>
      <a href="../articles/strategy.html">Implementing a new strategy</a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/developer_notes.html">
    <span class="fas fa-terminal"></span>
     
    Developer Notes
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="../news/index.html">
    <span class="fas fa-newspaper-o"></span>
     
    News
  </a>
</li>
<li>
  <a href="https://github.com/traitecoevo/plant">
    <span class="fas fa-github fa-lg"></span>
     
    Github
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Cohort spacing algorithm</h1>
                        <h4 class="author">Rich FitzJohn</h4>
                        <h4 class="author">Daniel Falster</h4>
            
            <h4 class="date">2016</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/traitecoevo/plant/blob/master/vignettes/cohort_spacing.Rmd"><code>vignettes/cohort_spacing.Rmd</code></a></small>
      <div class="hidden name"><code>cohort_spacing.Rmd</code></div>

    </div>

    
    
<div id="background" class="section level1">
<h1 class="hasAnchor">
<a href="#background" class="anchor"></a>Background</h1>
<p>As described in the <a href="https://traitecoevo.github.io/plant/articles/demography.html#approximation-of-size-density-distribution-via-the-scm">demography vignette</a>, the spacing of cohorts can affect the accuracy of integration over the size-density distribution. <code>plant</code> uses an adaptive algorithm to build an appropriately spaced cohort schedule with the desired accuracy at every time point, using as few cohorts as possible.</p>
<p>The <code>build_schedule</code> function takes an initial vector of introduction times and considers for each cohort whether removing that cohort causes the error introduced when integrating two specified functions over the size-density distribution to jump over the allowable error threshold <code>schedule_eps</code>. This calculation is repeated for every time step in the development of the patch. A new cohort is introduced immediately prior to any cohort failing these tests. The dynamics of the patch are then simulated again and the process is repeated, until all integrations at all time points have an error below the tolerable limit <code>schedule_eps</code>. Decreasing <code>schedule_eps</code> demands higher accuracy from the solver, and thus increases the number of cohorts being introduced. Note that we are assessing whether removing an existing cohort causes the error to jump above the threshold limit, and using this to decide whether an extra cohort – in addition to the one used in the test – should be introduced. Thus, the actual error is likely to be lower than, but at most equal to, <code>schedule_eps</code>.</p>
<p>This vignette shows some details of cohort splitting, most of which happens automatically. It’s probably not very interesting to most people, only those interested in knowing how the SCM technique works in detail. It also uses a lot of non-exported, non-documented functions from plant so you’ll see a lot of <code>plant:::</code> prefixes.</p>
</div>
<div id="cohort-introduction-times" class="section level1">
<h1 class="hasAnchor">
<a href="#cohort-introduction-times" class="anchor"></a>Cohort introduction times</h1>
<!-- TODO: elaborate on why concentrating concentrating early helps -->
<p>The default cohort introduction times are designed to concentrate cohort introductions onto earlier times, based on empirical patterns of cohort refining:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/traitecoevo/plant">plant</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span>
<span class="va">n_cores</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>

<span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/scm_base_parameters.html">scm_base_parameters</a></span><span class="op">(</span><span class="st">"FF16"</span><span class="op">)</span>
<span class="va">patch</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/expand_parameters.html">expand_parameters</a></span><span class="op">(</span><span class="fu"><a href="../reference/trait_matrix.html">trait_matrix</a></span><span class="op">(</span><span class="fl">0.0825</span>, <span class="st">"lma"</span><span class="op">)</span>, <span class="va">params</span>, mutant <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="va">patch</span><span class="op">$</span><span class="va">seed_rain</span> <span class="op">&lt;-</span> <span class="fl">20</span>

<span class="va">times_default</span> <span class="op">&lt;-</span> <span class="va">patch</span><span class="op">$</span><span class="va">cohort_schedule_times</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">times_default</span>, cex<span class="op">=</span><span class="fl">.2</span>, pch<span class="op">=</span><span class="fl">19</span>, ylab<span class="op">=</span><span class="st">"Time (years)"</span>, las<span class="op">=</span><span class="fl">1</span><span class="op">)</span></code></pre></div>
<p><img src="figure/cohort_spacing__unnamed-chunk-1-1.png"><!-- TODO: explain how introducing two species together reduces work --></p>
<p>The actual differences are stepped in order to increase the chance that cohorts from different species will be introduced at the same time and reduce the total amount of work being done.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span><span class="op">(</span><span class="va">times_default</span><span class="op">)</span>, pch<span class="op">=</span><span class="fl">19</span>, cex<span class="op">=</span><span class="fl">.2</span>, ylab<span class="op">=</span><span class="st">"Time difference (years)"</span>, las<span class="op">=</span><span class="fl">1</span><span class="op">)</span></code></pre></div>
<p><img src="figure/cohort_spacing__unnamed-chunk-2-1.png"></p>
</div>
<div id="seed-rain" class="section level1">
<h1 class="hasAnchor">
<a href="#seed-rain" class="anchor"></a>Seed rain</h1>
<p>We can assess the impact of cohort spacing on integration error by examining the cumulative propagule output (e.g. seed rain) of a patch.</p>
<p>Increasing the number of cohorts is expected to increase integration accuracy at the expense of more computational effort. We can create more refined schedules by interleaving points into the existing schedule:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">interleave</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
  <span class="va">xp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="op">-</span><span class="va">n</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span>, <span class="cn">NA</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">xp</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="op">-</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">n</span><span class="op">]</span>
<span class="op">}</span>


<span class="va">times_2x</span> <span class="op">&lt;-</span> <span class="fu">interleave</span><span class="op">(</span><span class="va">times_default</span><span class="op">)</span>
<span class="va">times_4x</span> <span class="op">&lt;-</span> <span class="fu">interleave</span><span class="op">(</span><span class="va">times_2x</span><span class="op">)</span>
<span class="va">times_8x</span> <span class="op">&lt;-</span> <span class="fu">interleave</span><span class="op">(</span><span class="va">times_4x</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">times_default</span>, xlab <span class="op">=</span> <span class="st">"Cohort #"</span>, ylab<span class="op">=</span><span class="st">"Time (years)"</span>, 
     xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">times_8x</span><span class="op">)</span><span class="op">)</span>, las<span class="op">=</span><span class="fl">1</span>, pch <span class="op">=</span> <span class="fl">19</span>, cex<span class="op">=</span><span class="fl">.2</span>,<span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span><span class="va">times_2x</span>, pch<span class="op">=</span><span class="fl">19</span>, cex<span class="op">=</span><span class="fl">.2</span>, las<span class="op">=</span><span class="fl">1</span>, col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span><span class="va">times_4x</span>, pch<span class="op">=</span><span class="fl">19</span>, cex<span class="op">=</span><span class="fl">.2</span>, las<span class="op">=</span><span class="fl">1</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span><span class="va">times_8x</span>, pch<span class="op">=</span><span class="fl">19</span>, cex<span class="op">=</span><span class="fl">.2</span>, las<span class="op">=</span><span class="fl">1</span>, col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></code></pre></div>
<p><img src="figure/cohort_spacing__unnamed-chunk-3-1.png"> Each schedule runs for the same duration, but <code>times_high</code> has 4x as many cohorts. Running a patch with each cohort schedule allows us to compare the propagule outputs:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">run_with_times</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">patch</span>, <span class="va">t</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">patch</span><span class="op">$</span><span class="va">cohort_schedule_times</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">t</span>
  
  <span class="va">start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
  <span class="va">seed_rain</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_scm.html">run_scm</a></span><span class="op">(</span><span class="va">patch</span><span class="op">)</span><span class="op">$</span><span class="va">seed_rains</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Time to solve:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="va">start</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">seed_rain</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">seed_rain_default</span> <span class="op">&lt;-</span> <span class="fu">run_with_times</span><span class="op">(</span><span class="va">patch</span>, <span class="va">times_default</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "Time to solve: 3.55"</code></pre>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">seed_rain_2x</span> <span class="op">&lt;-</span> <span class="fu">run_with_times</span><span class="op">(</span><span class="va">patch</span>, <span class="va">times_2x</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "Time to solve: 7.54"</code></pre>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">seed_rain_4x</span> <span class="op">&lt;-</span> <span class="fu">run_with_times</span><span class="op">(</span><span class="va">patch</span>, <span class="va">times_4x</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "Time to solve: 24.06"</code></pre>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">seed_rain_8x</span> <span class="op">&lt;-</span> <span class="fu">run_with_times</span><span class="op">(</span><span class="va">patch</span>, <span class="va">times_8x</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "Time to solve: 1.26"</code></pre>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cohort_range</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">times_default</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">times_2x</span><span class="op">)</span>, 
                  <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">times_4x</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">times_8x</span><span class="op">)</span><span class="op">)</span>
<span class="va">seed_rain_range</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">seed_rain_default</span>, <span class="va">seed_rain_2x</span>, 
                     <span class="va">seed_rain_4x</span>, <span class="va">seed_rain_8x</span><span class="op">)</span></code></pre></div>
<p>Quadrupling the number of cohorts results in nearly a 6x increase in runtime, eight times the cohorts takes roughly 26x longer.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">cohort_range</span>, y <span class="op">=</span> <span class="va">seed_rain_range</span>,
     xlab<span class="op">=</span><span class="st">"Number of cohort introductions"</span>, ylab<span class="op">=</span><span class="st">"Seed rain"</span>, las<span class="op">=</span><span class="fl">1</span><span class="op">)</span></code></pre></div>
<p><img src="figure/cohort_spacing__unnamed-chunk-5-1.png"> Seed rain increases as cohorts are introduced more finely, though at a saturating rate, meaning there are diminishing returns in accuracy for additional cohorts.</p>
<p>The differences in seed rain are not actually that striking (perhaps 2%) but the introduced <em>variation</em> creates instabilities of sufficient concern.</p>
</div>
<div id="individual-seed-rain-contributions" class="section level1">
<h1 class="hasAnchor">
<a href="#individual-seed-rain-contributions" class="anchor"></a>Individual seed rain contributions</h1>
<p>Where is the fitness difference driving change in seed rain coming from?</p>
<p>Consider adding a <em>single</em> additional cohort at one of the points along the first vector of times <code>times_default</code> and computing the output seed rain:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">insert_time</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span>, <span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">j</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="va">j</span><span class="op">]</span>, <span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">/</span><span class="fl">2</span>, <span class="va">x</span><span class="op">[</span><span class="op">-</span><span class="va">j</span><span class="op">]</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">run_with_insert</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span>, <span class="va">patch</span>, <span class="va">t</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">run_with_times</span><span class="op">(</span><span class="va">patch</span>, <span class="fu">insert_time</span><span class="op">(</span><span class="va">i</span>, <span class="va">t</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">insert_positions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">times_default</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>
<span class="va">seed_rains</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/parallel/mclapply.html">mclapply</a></span><span class="op">(</span><span class="va">insert_positions</span>, <span class="va">run_with_insert</span>, 
                              <span class="va">patch</span>, <span class="va">times_default</span>, mc.cores <span class="op">=</span> <span class="va">n_cores</span><span class="op">)</span><span class="op">)</span>

<span class="va">seed_rain_differences</span> <span class="op">&lt;-</span> <span class="va">seed_rains</span> <span class="op">-</span> <span class="va">seed_rain_default</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">insert_positions</span>, <span class="va">seed_rain_differences</span>, 
     xlab<span class="op">=</span><span class="st">"Cohort #"</span>, ylab<span class="op">=</span><span class="st">"Difference from default seed rain"</span>, las<span class="op">=</span><span class="fl">1</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>h<span class="op">=</span><span class="fl">0</span>, col<span class="op">=</span><span class="st">"grey"</span><span class="op">)</span></code></pre></div>
<p><img src="figure/cohort_spacing__unnamed-chunk-6-1.png"></p>
<p>The biggest deviations in output seed rain come about half way through the schedule, though because of the compression of early times this occurs fairly early in patch development:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">times_interpolated</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">times_default</span><span class="op">[</span><span class="op">-</span><span class="fl">1L</span><span class="op">]</span> <span class="op">+</span> 
                         <span class="va">times_default</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">times_default</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">times_interpolated</span>, <span class="va">seed_rain_differences</span>,
     xlab<span class="op">=</span><span class="st">"Time (years)"</span>, ylab<span class="op">=</span><span class="st">"Difference from default seed rain"</span>, las<span class="op">=</span><span class="fl">1</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>h<span class="op">=</span><span class="fl">0</span>, col<span class="op">=</span><span class="st">"grey"</span><span class="op">)</span></code></pre></div>
<p><img src="figure/cohort_spacing__unnamed-chunk-7-1.png"> Now look at the contribution of different cohorts to the overall patch output (log scaled for clarity):</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">default</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_scm.html">run_scm</a></span><span class="op">(</span><span class="va">patch</span><span class="op">)</span>

<span class="co"># remove first cohort to avoid log(0)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">times_default</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>, <span class="va">default</span><span class="op">$</span><span class="fu">seed_rain_cohort</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>, log <span class="op">=</span> <span class="st">"y"</span>,
     xlab<span class="op">=</span><span class="st">"Time (years)"</span>, ylab<span class="op">=</span><span class="st">"Seed rain (log scale)"</span><span class="op">)</span>

<span class="va">top_5</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">seed_rain_differences</span><span class="op">)</span>, decreasing<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>v<span class="op">=</span><span class="va">times_interpolated</span><span class="op">[</span><span class="va">top_5</span><span class="op">]</span>, col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"red"</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"grey"</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="figure/cohort_spacing__unnamed-chunk-8-1.png"><!-- TODO: there might be a clearer way to summarise this point --></p>
<p>In this case almost all the contribution comes from early cohorts (this is essentially a single-age stand of pioneers).</p>
<p>Overlaid on this are the five cohorts where extra refinement (i.e. inserting an additional cohort) causes the largest change in overall seed rain output (biggest difference in red).</p>
<p>The difference is not coming from seed rain contributions of those cohorts, which is basically zero, though it is higher than the surrounding cohorts.</p>
</div>
<div id="individual-competitive-impacts" class="section level1">
<h1 class="hasAnchor">
<a href="#individual-competitive-impacts" class="anchor"></a>Individual competitive impacts</h1>
<p>If the inserted cohorts are not altering seed rain through individual contributions, they may be altering the output of neighbouring cohorts through comepttive interactions.</p>
<p>Here we investigate the differences in patch light environment after introducing the single cohort driving the greatest difference in seed output identified above.</p>
<p>First we run patches with and without the extra cohort, collecting the complete set of patch conditions at each timestep.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">collect_with_times</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">patch</span>, <span class="va">t</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">patch</span><span class="op">$</span><span class="va">cohort_schedule_times</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">t</span>
  <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_scm_collect.html">run_scm_collect</a></span><span class="op">(</span><span class="va">patch</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">insert_position</span> <span class="op">&lt;-</span> <span class="va">top_5</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
<span class="va">times_insert</span> <span class="op">&lt;-</span> <span class="fu">insert_time</span><span class="op">(</span><span class="va">insert_position</span>, <span class="va">times_default</span><span class="op">)</span>

<span class="va">results_default</span> <span class="op">&lt;-</span> <span class="fu">collect_with_times</span><span class="op">(</span><span class="va">patch</span>, <span class="va">times_default</span><span class="op">)</span>
<span class="va">results_insert</span> <span class="op">&lt;-</span> <span class="fu">collect_with_times</span><span class="op">(</span><span class="va">patch</span>, <span class="va">times_insert</span><span class="op">)</span></code></pre></div>
<p>In order to make a direct comparison, we need to interpolate the light environment over a common set of heights at each time step.</p>
<p>We reconstruct the light environment spline for both runs, and compute canopy openness in both:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">interpolated_environment</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">env</span>, <span class="va">heights</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># intialise new spline with existing values</span>
  <span class="va">spline</span> <span class="op">&lt;-</span> <span class="fu">plant</span><span class="fu">:::</span><span class="fu"><a href="../reference/Interpolator.html">Interpolator</a></span><span class="op">(</span><span class="op">)</span>
  <span class="va">spline</span><span class="op">$</span><span class="fu">init</span><span class="op">(</span><span class="va">env</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, <span class="va">env</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span><span class="op">)</span>
  
  <span class="co"># subset to valid heights in patch</span>
  <span class="va">patch_heights</span> <span class="op">&lt;-</span> <span class="va">heights</span> <span class="op">&lt;</span> <span class="va">spline</span><span class="op">$</span><span class="va">max</span>
  
  <span class="co"># evaluate over list of heights and zero</span>
  <span class="va">y</span> <span class="op">&lt;-</span> <span class="va">spline</span><span class="op">$</span><span class="fu">eval</span><span class="op">(</span><span class="va">heights</span><span class="op">)</span>
  <span class="va">y</span><span class="op">[</span><span class="op">!</span><span class="va">patch_heights</span><span class="op">]</span> <span class="op">=</span> <span class="fl">0</span>
  
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>
<span class="op">}</span> 

<span class="va">n</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">results_default</span><span class="op">$</span><span class="va">time</span><span class="op">)</span>

<span class="va">max_height</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">results_default</span><span class="op">$</span><span class="va">env</span><span class="op">[[</span><span class="va">n</span><span class="op">]</span><span class="op">]</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>,
                  <span class="va">results_insert</span><span class="op">$</span><span class="va">env</span><span class="op">[[</span><span class="va">n</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span>

<span class="va">heights</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">max_height</span>, length.out<span class="op">=</span><span class="fl">201</span><span class="op">)</span>
<span class="va">canopy_default</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">results_default</span><span class="op">$</span><span class="va">env</span>, <span class="va">interpolated_environment</span>, <span class="va">heights</span><span class="op">)</span>
<span class="va">canopy_insert</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">results_insert</span><span class="op">$</span><span class="va">env</span>, <span class="va">interpolated_environment</span>, <span class="va">heights</span><span class="op">)</span>

<span class="va">canopy_difference</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">canopy_insert</span><span class="op">[</span>, <span class="op">-</span><span class="op">(</span><span class="va">insert_position</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">]</span> <span class="op">-</span> <span class="va">canopy_default</span><span class="op">)</span>
<span class="va">canopy_difference</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">canopy_difference</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">1e-10</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></code></pre></div>
<p>Taking the difference between light environments at each height and timestep, the resulting image plot is blue in regions where the refined light environment, with the additional cohort is lighter (higher canopy openness) and red in regions where the the light environment is darker with the additional cohort.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># ColorBrewer's RdBu palette</span>
<span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"#B2182B"</span>, <span class="st">"#D6604D"</span>, <span class="st">"#F4A582"</span>, <span class="st">"#FDDBC7"</span>,
          <span class="st">"#D1E5F0"</span>, <span class="st">"#92C5DE"</span>, <span class="st">"#4393C3"</span>, <span class="st">"#2166AC"</span><span class="op">)</span>
<span class="va">pal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/colorRamp.html">colorRampPalette</a></span><span class="op">(</span><span class="va">cols</span><span class="op">)</span><span class="op">(</span><span class="fl">20</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/image.html">image</a></span><span class="op">(</span><span class="va">results_default</span><span class="op">$</span><span class="va">time</span>, <span class="va">heights</span>, <span class="va">canopy_difference</span>,
      xlab<span class="op">=</span><span class="st">"Time (years)"</span>, ylab<span class="op">=</span><span class="st">"Height (m)"</span>, las<span class="op">=</span><span class="fl">1</span>, col<span class="op">=</span><span class="va">pal</span><span class="op">)</span></code></pre></div>
<p><img src="figure/cohort_spacing__unnamed-chunk-11-1.png"> Canopy openness is 9.68% lower for ~7 m tall cohorts at year 25. This increased competitive intensity may be driving differences in seed rain.</p>
</div>
<div id="monitoring-integration-accuracy" class="section level1">
<h1 class="hasAnchor">
<a href="#monitoring-integration-accuracy" class="anchor"></a>Monitoring integration accuracy</h1>
<!-- TODO: find more general terms for 'area_leaf_error' -->
<p>The internal function <code>plant:::run_scm_error</code> runs the SCM and computes errors as the integration proceeds.</p>
<p>We integrate two different functions over the size-density distribution, <code>area_leaf_error</code> and <code>seed_rain_error</code>, and assess how much removing the focal cohort increases the error in these two integrations.</p>
<p><code>area_leaf_error</code>, determines how much the removal of the focal cohort increases the error in the estimate of the total leaf area in the patch.</p>
<p>Similarly, <code>seed_rain_error</code>, determines how much the removal of the focal cohort increases the error in the estimate of the total seed production from the patch. The relative error in each integration is then calculated using the <code>local_error_integration</code> function.</p>
<p>We’ve shown that large differences manifest in canopy openness. Here we use <code>plant:::run_scm_error</code> to assess the integration error of the leaf area for all cohorts.</p>
<p>The black line indicates the cohort identified as problematic above.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">patch_error</span> <span class="op">&lt;-</span> <span class="fu">plant</span><span class="fu">:::</span><span class="fu">run_scm_error</span><span class="op">(</span><span class="va">patch</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/image.html">image</a></span><span class="op">(</span><span class="va">times_default</span>, <span class="va">times_default</span>, <span class="va">patch_error</span><span class="op">$</span><span class="va">err</span><span class="op">$</span><span class="va">lai</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,
      xlab<span class="op">=</span><span class="st">"Patch age (years)"</span>, ylab<span class="op">=</span><span class="st">"Introduction time (years)"</span>, las<span class="op">=</span><span class="fl">1</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>h<span class="op">=</span><span class="va">times_default</span><span class="op">[</span><span class="va">top_5</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<p><img src="figure/cohort_spacing__unnamed-chunk-12-1.png"></p>
<p><code>plant:::run_scm_error</code> is used by the <code>build_schedule</code> function to find an appropriately refined cohort spacing algorithm that minimises both integration errors.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">patch_refined</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/build_schedule.html">build_schedule</a></span><span class="op">(</span><span class="va">patch</span><span class="op">)</span>
<span class="va">seed_rain_refined</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">patch_refined</span>, <span class="st">"seed_rain_out"</span><span class="op">)</span></code></pre></div>
<p>We can see the impact of this refinement by repeating our earlier analysis and inserting a new cohort at each timestep and extracting the seed rain:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">times_refined</span> <span class="op">&lt;-</span> <span class="va">patch_refined</span><span class="op">$</span><span class="va">cohort_schedule_times</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>

<span class="va">insert_positions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">times_refined</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>

<span class="va">seed_rains_refined</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/parallel/mclapply.html">mclapply</a></span><span class="op">(</span><span class="va">insert_positions</span>, <span class="va">run_with_insert</span>, 
                                      <span class="va">patch_refined</span>, <span class="va">times_refined</span>, 
                                      mc.cores <span class="op">=</span> <span class="va">n_cores</span><span class="op">)</span><span class="op">)</span>

<span class="va">refined_differences</span> <span class="op">=</span> <span class="va">seed_rains_refined</span> <span class="op">-</span> <span class="va">seed_rain_refined</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">insert_positions</span>, <span class="va">refined_differences</span>, 
     xlab<span class="op">=</span><span class="st">"Index"</span>, ylab<span class="op">=</span><span class="st">"Seed rain differences"</span>, las<span class="op">=</span><span class="fl">1</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>h<span class="op">=</span><span class="fl">0</span>, col<span class="op">=</span><span class="st">"grey"</span><span class="op">)</span></code></pre></div>
<p><img src="figure/cohort_spacing__unnamed-chunk-14-1.png"></p>
<p>Some cohorts still introduce variation, however errors in seed rain are reduced by an order of magnitude, and are even smaller if considering relative error:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">insert_positions</span>, <span class="va">seed_rains_refined</span> <span class="op">/</span> <span class="va">seed_rain_refined</span> <span class="op">-</span> <span class="fl">1</span>, 
     xlab<span class="op">=</span><span class="st">"Index"</span>, ylab<span class="op">=</span><span class="st">"Relative seed rain differences"</span>, las<span class="op">=</span><span class="fl">1</span><span class="op">)</span></code></pre></div>
<p><img src="figure/cohort_spacing__unnamed-chunk-15-1.png"> The refined cohort introduction schedule results in a seed rain near the saturating value identified in [# Seed rain] but with 211 cohorts rather than the 1121 cohorts used in naive interpolation.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Daniel Falster, Richard FitzJohn, Rafael Schouten, Andrew O'Reilly-Nugent.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
