<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Developer Notes • plant</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<script src="../extra.js"></script><meta property="og:title" content="Developer Notes">
<meta property="og:description" content="plant">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">plant</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.0.</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home"></span>
     
    Home
  </a>
</li>
<li>
  <a href="../articles/plant.html">
    <span class="fas fa-tree"></span>
     
    Getting Started
  </a>
</li>
<li>
  <a href="../reference/index.html">
    <span class="fas fa-list"></span>
     
    Reference
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fas fa-book"></span>
     
    Theory
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/demography.html">Demography of plants, patches, and metacommunities</a>
    </li>
    <li>
      <a href="../articles/physiology.html">The FF16 strategy</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fas fa-file-code-o"></span>
     
    Examples
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/individuals.html">Individual plants</a>
    </li>
    <li>
      <a href="../articles/patch.html">Patches of competing plants</a>
    </li>
    <li>
      <a href="../articles/equilibrium.html">Finding demographic equilibrium</a>
    </li>
    <li>
      <a href="../articles/emergent.html">Emergent properties of patches</a>
    </li>
    <li>
      <a href="../articles/fitness.html">Calculating fitness</a>
    </li>
    <li>
      <a href="../articles/cohort_spacing.html">The cohort spacing algorithm</a>
    </li>
    <li>
      <a href="../articles/parameters.html">Changing parameters</a>
    </li>
    <li>
      <a href="../articles/strategy.html">Implementing a new strategy</a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/developer_notes.html">
    <span class="fas fa-terminal"></span>
     
    Developer Notes
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="../news/index.html">
    <span class="fas fa-newspaper-o"></span>
     
    News
  </a>
</li>
<li>
  <a href="https://github.com/traitecoevo/plant">
    <span class="fas fa-github fa-lg"></span>
     
    Github
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Developer Notes</h1>
            
            <h4 class="date">2021-02-25</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/traitecoevo/plant/blob/master/vignettes/developer_notes.Rmd"><code>vignettes/developer_notes.Rmd</code></a></small>
      <div class="hidden name"><code>developer_notes.Rmd</code></div>

    </div>

    
    
<div id="development" class="section level1">
<h1 class="hasAnchor">
<a href="#development" class="anchor"></a>Development</h1>
<div id="issues" class="section level2">
<h2 class="hasAnchor">
<a href="#issues" class="anchor"></a>Issues</h2>
<p>We use <a href="https://github.com/traitecoevo/plant/issues/">github issues</a> for feature requests, bug reports and developer coordination.</p>
</div>
<div id="gitflow-workflow" class="section level2">
<h2 class="hasAnchor">
<a href="#gitflow-workflow" class="anchor"></a>Gitflow workflow</h2>
<p>We use the <a href="https://www.atlassian.com/git/tutorials/comparing-workflows/gitflow-workflow">Gitflow</a> workflow. This means we have two main branches:</p>
<ol style="list-style-type: decimal">
<li>a master branch (<code>master</code>) for stable releases</li>
<li>a development branch (<code>develop</code>) where all development takes place</li>
</ol>
<p>We also use feature branches which branch from the development branch where we can then introduce new features and then pull them back into the development branch.</p>
</div>
<div id="compiling" class="section level2">
<h2 class="hasAnchor">
<a href="#compiling" class="anchor"></a>Compiling</h2>
<p>The makefile defines multiple targets in the package build process. These are called by running</p>
<pre><code>make target_name</code></pre>
<p>where <code>target_name</code> is the target to build. Targets are as follows:</p>
<ul>
<li>
<strong><code>all</code></strong>: Compiles the package and builds the function documentation to <code>/man</code>
</li>
<li>
<strong><code>install</code></strong>: Installs this package (<code>R CMD INSTALL .</code>)</li>
<li>
<strong><code>build</code></strong>: Builds plant (<code>R CMD build --no-build-vignettes</code>)</li>
<li>
<strong><code>RcppR6</code></strong>: Update or install RcppR6 files</li>
<li>
<strong><code>attributes</code></strong>: Scans the source files for attributes and generate code as required. Generates the bindings required to call C++ functions from R for functions labelled with the <code>Rcpp::export</code> attribute</li>
<li>
<strong><code>roxygen</code></strong>: Compiles the documentation for R</li>
<li>
<strong><code>test</code></strong> Run the test suite</li>
<li>
<strong><code>check</code></strong>: <a href="http://r-pkgs.had.co.nz/check.html">Checks</a> plant for common problems</li>
<li>
<strong><code>clean</code></strong>: Deletes <code>*.o</code> and <code>*.so</code> files that were produced when compiling the package</li>
<li>
<strong><code>vignettes</code></strong>: Builds the vignettes</li>
<li>
<strong><code>website</code></strong>: Makes the website using pkgdown</li>
</ul>
</div>
</div>
<div id="design-structure" class="section level1">
<h1 class="hasAnchor">
<a href="#design-structure" class="anchor"></a>Design &amp; Structure</h1>
<p><code>plant</code> is build as an R package using C++ code, linked via <a href="https://cran.r-project.org/package=Rcpp">Rcpp</a>. Rcpp provides “provides R functions as well as C++ classes which offer a seamless integration of R and C++.”</p>
<p>Two common challenges with using Rcpp are 1) that there is a lot of interface code (or “boilerplate”) needed, 2) Rcpp “modules” can be slow to load. To overcome these we use the package <a href="https://github.com/richfitz/RcppR6">RcppR6</a> to generate the interface. The RcppR6 package aims to provide a simple way of generating boilerplate code for exposing C++ classes to R. It is similar in many ways to Rcpp “modules” but without the slow load time. RcppR6 creates an interface using Rcpp’s <a href="http://dirk.eddelbuettel.com/code/rcpp/Rcpp-attributes.pdf">“attributes”</a> facilities to build the actual R/C++ glue. The <a href="https://github.com/wch/R6">R6</a> R package is the reference class that we use for wrapping the generated class. To achieve the link, class definitions are written into a <a href="http://en.wikipedia.org/wiki/YAML">YAML</a> file.</p>
<div id="directory-structure" class="section level2">
<h2 class="hasAnchor">
<a href="#directory-structure" class="anchor"></a>Directory Structure</h2>
<p>The code is organised as follows. This structure reflects structure generally used for R packages including C++ source.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb2-1" title="1">├── <span class="ex">docker</span>              <span class="co"># Docker files</span></a>
<a class="sourceLine" id="cb2-2" title="2">│   └── <span class="ex">plant-test</span></a>
<a class="sourceLine" id="cb2-3" title="3">├── <span class="ex">inst</span></a>
<a class="sourceLine" id="cb2-4" title="4">│   ├── <span class="ex">RcppR6_classes.yml</span>    <span class="co"># Used by RCppR6 to generate the interface for Rcpp (C++ classes)</span></a>
<a class="sourceLine" id="cb2-5" title="5">│   ├── <span class="ex">RcppR6_functions.yml</span>  <span class="co"># Used by RCppR6 to generate the interface for Rcpp (C++ function)</span></a>
<a class="sourceLine" id="cb2-6" title="6">│   ├── <span class="ex">include</span></a>
<a class="sourceLine" id="cb2-7" title="7">│   │   ├── <span class="ex">plant.h</span> <span class="co"># THE main header file for package - sources other headers</span></a>
<a class="sourceLine" id="cb2-8" title="8">│   │   ├── <span class="ex">plant</span>   <span class="co"># header (.h) files for different components, many including implementation</span></a>
<a class="sourceLine" id="cb2-9" title="9">│   │   └── <span class="ex">tk</span>      <span class="co"># simple cubic spline interpolation library</span></a>
<a class="sourceLine" id="cb2-10" title="10">│   ├── <span class="ex">reference_plant_ff16</span> <span class="co"># Reference plant physiology ff16</span></a>
<a class="sourceLine" id="cb2-11" title="11">│   ├── <span class="ex">docs</span>            <span class="co"># Files for building the documentation</span></a>
<a class="sourceLine" id="cb2-12" title="12">│   ├── <span class="ex">scripts</span>         <span class="co"># Tools used in package management</span></a>
<a class="sourceLine" id="cb2-13" title="13">│   └── <span class="ex">website</span>         <span class="co"># Reference plant physiology ff16</span></a>
<a class="sourceLine" id="cb2-14" title="14">├── <span class="fu">man</span>                     <span class="co"># R Documentation files (*.Rd)</span></a>
<a class="sourceLine" id="cb2-15" title="15">├── <span class="ex">R</span>                           <span class="co"># R functions</span></a>
<a class="sourceLine" id="cb2-16" title="16">├── <span class="ex">scripts</span>             <span class="co"># R scripts</span></a>
<a class="sourceLine" id="cb2-17" title="17">├── <span class="ex">src</span>                     <span class="co"># C++ files with implementation where not included in headers</span></a>
<a class="sourceLine" id="cb2-18" title="18">├── <span class="ex">tests</span>               <span class="co"># Tests</span></a>
<a class="sourceLine" id="cb2-19" title="19">└── <span class="ex">vignettes</span>           <span class="co"># Empty until the documentation is built</span></a></code></pre></div>
</div>
<div id="templating" class="section level2">
<h2 class="hasAnchor">
<a href="#templating" class="anchor"></a>Templating</h2>
<p>We use templating to enable plant to work with multiple strategies and lets us write code that is strategy generic. The templated class definitions are found in <code>inst/include/plant</code> and their function implementations are found either in the <code>.h</code> files or in <code>/src</code>.</p>
<p>We then use the <a href="https://github.com/richfitz/RcppR6">RcppR6</a> package combined with the <code>.h</code> files and class definitions (found in <code>inst/RcppR6_classes.yml</code>) into Rcpp which we can then be used in the <code>.R</code> files (in <code>/R</code>) or exported.</p>
<p>Templating Resources:</p>
<ul>
<li><a href="http://htmlpreview.github.io/?https://raw.githubusercontent.com/richfitz/RcppR6/master/inst/doc/templates.html">RccpR6 Templates</a></li>
<li><a href="https://en.wikipedia.org/wiki/Template_(C%2B%2B)">Templating in C++</a></li>
</ul>
</div>
<div id="classes-and-their-functions" class="section level2">
<h2 class="hasAnchor">
<a href="#classes-and-their-functions" class="anchor"></a>Classes and their functions</h2>
<p>The main c++ header files (i.e. *.h) are stored within the directory <code>inst/include/plant/</code>. In many cases, the implementations is written directly into the header files. Otherwise, the corresponding source file (i.e. *.cpp) is stored within the folder <code>src</code>.</p>
<p>The role of these different files is as follows.</p>
<p>strategies: ff16_strategy.h</p>
<p>plant.h</p>
<p>cohort.h</p>
<p>species.h</p>
<p>patch.h</p>
<p>SCM.h</p>
<p>Helpers:</p>
<ul>
<li>parameters.h</li>
<li>cohort_schedule.h</li>
<li>control.h</li>
<li>disturbance.h</li>
<li>environment.h</li>
</ul>
<p>plant_runner.h plant_tools.h scm_utils.h</p>
<p>stochastic_patch_runner.h stochastic_patch.h stochastic_species.h stochastic_utils.h</p>
<div id="utilities" class="section level3">
<h3 class="hasAnchor">
<a href="#utilities" class="anchor"></a>Utilities</h3>
<p>adaptive_interpolator.h get_state.h gradient.h interpolator.h lorenz.h ode_control.h ode_interface.h ode_r.h ode_runner.h ode_solver.h ode_step.h qag_internals.h qag.h qk_rules.h qk.h</p>
<p>RcppR6_post.hpp RcppR6_pre.hpp RcppR6_support.hpp uniroot.h util_post_rcpp.h util.h</p>
</div>
</div>
<div id="strategies" class="section level2">
<h2 class="hasAnchor">
<a href="#strategies" class="anchor"></a>Strategies</h2>
<p>The foundation of the <code>plant</code> package are sub-models for an individual species’ physiological strategy. The <code>FF16</code> strategy is the default strategy. However, the plant package has been written to enable new physiological strategies to be added, and then use the same machinery for modelling size-structured population dynamics, we do this by using templating in C++11 (see <a href="#templating">Templating</a>).</p>
<p>Adding a new physiological strategy requires some changes to be made throughout the code and then the code recompiled. To achieve this, you’ll need to download the package code from Github (new strategies cannot be added using an installed R package) and follow the instructions below.</p>
<p>As a naming convention, strategies are named using two initials r (eg. the first two authors) followed by a year, e.g. <code>FF16</code>. A single letter suffix can be added to indicate a minor modification of an existing strategy, e.g. <code>FF16r</code>.</p>
<div id="installing-new-strategies" class="section level3">
<h3 class="hasAnchor">
<a href="#installing-new-strategies" class="anchor"></a>Installing new strategies</h3>
<p>Let’s assume you want to add a new strategy called <code>XX99</code>. To add this strategy, the following changes are required. First, some new files need to be created:</p>
<ul>
<li>
<code>inst/include/plant/XX99_strategy.h</code> (C++ header file, describing strategy)</li>
<li>
<code>src/XX99_strategy.cpp</code> (C++ source file, describing strategy)</li>
<li>
<code>R/XX99.R</code> (R wrapper functions for the new strategy, plus hyperparameter function)</li>
<li>
<code>tests/testthat/test-strategy-XX99.R</code> (Tests of the new strategy)</li>
</ul>
<p>In addition, the following files must be modified to include appropriate details for the new strategy (use the examples for <code>FF16</code> as a guide):</p>
<ul>
<li><code>inst/include/RccpR6_classes.yml</code></li>
<li><code>inst/include/plant.h</code></li>
<li><code>src/plant_plus.cpp</code></li>
<li><code>src/plant_tools.cpp</code></li>
<li><code>tests/testthat/helper-plant.R</code></li>
<li>
<code>R/scm_support.R</code> (Currently uses the FF16 hyperpar and make_hyperpar)</li>
</ul>
<p>Rather than making the above modifications by hand, you can use the scaffolder found in <code>inst/scripts/new_strategy_scaffolder.R</code> to create a suitable template. The scaffolder is set up to add code at appropriate points.</p>
<p>Before trying to install a new strategy, make sure your project is at a state where you are happy to go back to if you decide to, ie: do this in a new branch or fork. There is no easy way to undo the changes so you will have to do <code>git reset --hard HEAD</code> if you want to go back. You will still have to delete the new and untracked files listed above.</p>
<p>To install a new strategy using the scaffolder, run the following code from an R session at the project root:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="st">'inst/scripts/new_strategy_scaffolder.R'</span><span class="op">)</span>
<span class="fu">create_strategy_scaffold</span><span class="op">(</span><span class="st">"XX99"</span>, <span class="st">"FF16"</span><span class="op">)</span></code></pre></div>
<p>where <code>XX99</code> is the name of your new strategy and <code>FF16</code> is the strategy that you want to copy from. If run without <code>FF16</code>, the scaffolder copies from the <code>FF16</code> strategy by default.</p>
<p>This will create the code-base for a new template. Then run <code>make clean; make; make test</code>to recompile and run the test suite with your new strategy template.</p>
<p>If that works you can then modify the files <code>src/XX99_strategy.cpp</code> and <code>inst/include/plant/XX99_strategy.h</code> to reflect any changes in biology you desire for the new strategy. If you make changes to your new strategies parameters you will have to update the files: * <code>inst/include/RccpR6_classes.yml</code> - see top-level section under the new strategy name, describing your parameters. * <code>tests/testthat/test-strategy-XX99.R</code> with suitable tests for your new strategy.</p>
<p>Then recompile and test as above.</p>
<p>After the project compiles, you will notices even more files that have changed, for example in files like <code>NAMESPACE</code>, <code>R/RcppExports.R</code> etc. These files are auto-generated and therefore modifications are triggered from files listed above.</p>
</div>
</div>
</div>
<div id="website" class="section level1">
<h1 class="hasAnchor">
<a href="#website" class="anchor"></a>Website</h1>
<div id="building-the-website" class="section level2">
<h2 class="hasAnchor">
<a href="#building-the-website" class="anchor"></a>Building the website:</h2>
<p>To build and push the website to the <code>gh-pages</code> branch run <code>make website</code>. This first builds the vignettes from <code>/inst/docs</code> then builds the site with <a href="http://pkgdown.r-lib.org">pkgdown</a>. The site is then pushed to the <code>gh-pages</code> branch. (<a href="https://traitecoevo.github.io/plant" class="uri">https://traitecoevo.github.io/plant</a>)</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Daniel Falster, Richard FitzJohn, Rafael Schouten, Andrew O'Reilly-Nugent.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
