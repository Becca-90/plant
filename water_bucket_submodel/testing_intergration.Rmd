---
title: "R Notebook"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r warning=FALSE}
rm(list=ls())

library(dplyr)
library(tidyr)
library(ggplot2)
library(purrr)
library(deSolve)


source("R/solar_model.R")
source("R/reference_leaf.R")
source("R/reference_soil.R")
```

```{r}
nseq = 3

soil_params <- set_params_soil(vcmax = seq(10,100, length.out = nseq), p50 = seq(1,10, length.out =nseq), h_v = seq(0.000157*0.5, 0.000157*5, length.out=nseq), h = seq(1, 100, length.out=nseq), c = seq(1,10, length.out = nseq), beta1 = seq(1000, 15000, length.out=nseq), beta2 = seq(1, 5, length.out=nseq), day = seq(1,180, length.out = nseq), latitude = seq(0, 50, length.out = nseq), evap_routine = "1")
```

```{r}
calc_daily_model <- function(params){
  soil_params %>%
  mutate(daily_data = map2(latitude, day, ~calc_PPFD_instant(.x, .y))) %>%
  select(-c(latitude, day)) %>%
  unnest(daily_data) %>%
  rowwise() %>%
  mutate(VPD_hourly = calc_VPD_daily(sun_up, sun_down, VPD_9, VPD_15, instant_of_day)) %>%
  rowwise() %>%
  mutate(profit = find_opt_psi_stem_bartlett(psi_soil = psi_soil, k_l_max = k_l_max, vcmax = vcmax, PPFD = PPFD_umol_m2_s_instant, b = b, c = c, psi_crit = psi_crit, atm_vpd = VPD_hourly, ca = ca, beta = beta1, beta_2 = beta2, huber_value = h_v, height = h)$profit_root)
}

```

```{r}
calc_one_point <- function(data){
  data %>%
    slice(12,1) %>%
    pull(profit)  -> profits
  
  night_day_profit <- c(profits[2], profits[1])
  data %>%
    filter(PPFD_umol_m2_s_instant != 0) %>%
    summarise(length_day = max(instant_of_day) - min(instant_of_day)) %>%
    mutate(length_night = 1 - length_day) -> night_day_length
  
  sum(night_day_length*night_day_profit)
}


calc_three_point <- function(data){
  
      browser()

  data %>%
    spline(x = .$instant_of_day, y = .$profit, xmin = sun_up, xmax = sun_down, n = 3, method = "natural")
  

}


```


```{r}
outputs <- calc_daily_model(soil_params)

saveRDS(outputs, "outputs.RDS")
```

```{r}
outputs %>%
  ungroup() %>%
  nest(daily_data = c(profit, instant_of_day, PPFD_umol_m2_s_instant, VPD_hourly, sun_up, sun_down, day_length)) %>%
  mutate(true_daily_profit = map_dbl(daily_data, ~plant:::trapezium(.x$instant_of_day, .x$profit))) %>%
  mutate(estimated_daily_profit = map_dbl(daily_data, calc_one_point)) -> outputs_integrated
```

```{r}
outputs_integrated %>%
  ggplot(aes(x = true_daily_profit, y = estimated_daily_profit, col = as.factor(day), shape = as.factor(vcmax))) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0)


outputs %>%
  ungroup() %>%
  mutate(group = rep(seq(1, 19683), each = 24)) %>%
  ggplot(aes(x = instant_of_day, y = profit, group = as.factor(group), col = as.factor(day))) +
  geom_line()
```



```{r}

calc_VPD_daily <- function(sun_up, sun_down, VPD_9, VPD_15, instant_of_day) {
  
  VPD_data <- tibble(time = c(0,unique(sun_up),unique(sun_down),1), VPD = c(1, unique(VPD_9), unique(VPD_15), 1))

  VPD_data %>%
  spline(x = .$time, y = .$VPD, xout = instant_of_day, method = "natural") %>%
    as_tibble() %>%
    pull(y)
  
}
```
