---
title: "R Notebook"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r warning=FALSE}
rm(list=ls())

library(dplyr)
library(tidyr)
library(ggplot2)
library(purrr)
library(deSolve)


source("R/solar_model.R")
source("R/reference_leaf.R")
source("R/reference_soil.R")
```

```{r}
nseq = 20

soil_params <- set_params_soil(day = seq(1,180, length.out = nseq), evap_routine = "1")
```

```{r}
calc_daily_model <- function(params){
  soil_params %>%
  mutate(daily_data = map2(latitude, day, ~calc_PPFD_instant(.x, .y))) %>%
  select(-c(latitude, day)) %>%
  unnest(daily_data) %>%
  rowwise() %>%
  mutate(VPD_hourly = calc_VPD_daily(0.25, 0.75, VPD_9, VPD_15, instant_of_day)) %>%
  rowwise() %>%
  mutate(profit = find_opt_psi_stem_bartlett(psi_soil = psi_soil, k_l_max = k_l_max, vcmax = vcmax, PPFD = PPFD_umol_m2_s_instant, b = b, c = c, psi_crit = psi_crit, atm_vpd = VPD_hourly, ca = ca, beta = beta1, beta_2 = beta2, huber_value = h_v, height = h)$profit_root)
}

```

```{r}
calc_one_point <- function(data){
  data %>%
    slice(101,1) %>%
    pull(profit)  -> profits
  
  day_night_profit <- c(profits[1], profits[2])
  data %>%
    slice(1) %>%
    summarise(day_length = day_length, night_length = 1 - day_length) -> day_night_length
  sum(day_night_length*day_night_profit)
}


calc_three_point <- function(data, num_sects){

  slice(data, 1) %>% pull(profit) -> night_profits
  
  unique(data$day_length/(num_sects-1))->day_frac
  
  
  with(data, seq(from = unique(sun_up), to = unique(sun_down), by = day_frac))[2:num_sects] %>%
    map(~which.min(abs(data$instant_of_day - .x))) %>%
    unlist() %>%
    slice(data, .) -> time_outputs
  
  
  with(data, seq(from = unique(sun_up) - 0.5*day_frac, to = unique(sun_down) - 0.5*day_frac, by = day_frac))[2:num_sects] %>%
    map(~which.min(abs(data$instant_of_day - .x))) %>%
    unlist() %>%
    slice(data, .) -> profit_outputs
  
  
  times <- c(time_outputs$instant_of_day[1] - time_outputs$sun_up[1], diff(time_outputs$instant_of_day))
  profits <- profit_outputs$profit
  
  day_profit <- sum(times*profits)
  night_profit <- night_profits * (1-unique(data$day_length))
  
  day_profit+night_profit
  }


```


```{r}
outputs <- calc_daily_model(soil_params)

saveRDS(outputs, "outputs.RDS")
```

```{r}
outputs %>%
  ungroup() %>%
  nest(daily_data = c(profit, instant_of_day, PPFD_umol_m2_s_instant, VPD_hourly, sun_up, sun_down, day_length)) %>%
  mutate(true_daily_profit = map_dbl(daily_data, ~plant:::trapezium(.x$instant_of_day, .x$profit))) %>%
  mutate(estimated_daily_profit_1 = map_dbl(daily_data, calc_one_point)) %>%
  mutate(estimated_daily_profit_3 = map_dbl(daily_data, calc_three_point, 5)) -> outputs_integrated
```

```{r}
outputs_integrated %>%
  pivot_longer(contains("estimated")) %>%
  ggplot(aes(x = true_daily_profit, y = value, col = name)) + 
  geom_point()

cor(outputs_integrated$true_daily_profit, outputs_integrated$estimated_daily_profit_1)
cor(outputs_integrated$true_daily_profit, outputs_integrated$estimated_daily_profit_3)

outputs_integrated %>%
  ggplot(aes(x = true_daily_profit, y = estimated_daily_profit, col = as.factor(day))) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0)

outputs_integrated$daily_data[[1]] %>%
  slice(101)

outputs %>%
  filter(day == 1) %>%
  ggplot() +
  geom_line(aes(x = instant_of_day, y = profit)) +
  geom_polygon(data = outputs_integrated$daily_data[[1]][101,] %>% pivot_longer(contains("sun")),aes(x=value, y = profit), fill = "black")
```



```{r}

calc_VPD_daily <- function(sun_up, sun_down, VPD_9, VPD_15, instant_of_day) {
  
  VPD_data <- tibble(time = c(0,unique(sun_up),unique(sun_down),1), VPD = c(1, unique(VPD_9), unique(VPD_15), 1))

  VPD_data %>%
  spline(x = .$time, y = .$VPD, xout = instant_of_day, method = "natural") %>%
    as_tibble() %>%
    pull(y)
  
}
```
