---
title: "R Notebook"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r warning=FALSE}
rm(list=ls())

library(dplyr)
library(tidyr)
library(ggplot2)
library(purrr)
library(deSolve)


source("R/solar_model.R")
source("R/reference_leaf.R")
source("R/reference_soil.R")
```

```{r}
calc_daily_model <- function(params){
  soil_params %>%
  mutate(daily_data = map2(latitude, day, ~calc_PPFD_instant(.x, .y))) %>%
  select(-c(latitude, day)) %>%
  unnest(daily_data) %>%
  rowwise() %>%
  mutate(VPD_hourly = calc_VPD_daily(sun_up, sun_down, VPD_9, VPD_15, instant_of_day)) %>%
  rowwise() %>%
  mutate(profit = find_opt_psi_stem_bartlett(psi_soil = psi_soil, k_l_max = k_l_max, vcmax = vcmax, PPFD = PPFD_umol_m2_s_instant, b = b, c = c, psi_crit = psi_crit, atm_vpd = VPD_hourly, ca = ca, beta = beta1, beta_2 = beta2, huber_value = h_v, height = h)$profit_root)
}

```


```{r}

calc_VPD_daily <- function(sun_up, sun_down, VPD_9, VPD_15, instant_of_day) {
  
  VPD_data <- tibble(time = c(0,unique(sun_up),unique(sun_down),1), VPD = c(1, unique(VPD_9), unique(VPD_15), 1))

  VPD_data %>%
  spline(x = .$time, y = .$VPD, xout = instant_of_day, method = "natural") %>%
    as_tibble() %>%
    pull(y)
  
}
```


```{r}
calc_true_daily <- function(data){

slice(data, 1) %>%
  pull(profit) -> night_profits
  
night_frac <- 1 - slice(data, 1) %>%
  pull(day_length)


data %>% 
  filter(sun_up <= instant_of_day & instant_of_day <= sun_down) %>%
  summarise(profit = plant:::trapezium(x = .$instant_of_day, y = .$profit)) %>%
  pull(profit) -> profit

profit + night_profits*night_frac

}
```

```{r}
calc_one_point <- function(data){
  data %>%
    slice(101,1) %>%
    pull(profit)  -> profits
  
  day_night_profit <- c(profits[1], profits[2])
  data %>%
    slice(1) %>%
    summarise(day_length = day_length, night_length = 1 - day_length) -> day_night_length
  # sum(day_night_length*day_night_profit)
  sum(day_night_length[1]*day_night_profit[1])

}
```

```{r}

calc_defined_points <- function(data, defined_sects){
  
slice(data, 1) %>%
  pull(profit) -> night_profits


map(defined_sects, ~which.min(abs(data %>% pull(instant_of_day) - .x))) %>% unlist() %>% slice(data, .) -> day_profits

diff(c(day_profits$sun_up[1],day_profits$instant_of_day,day_profits$sun_down[1])) -> day_segments

browser()
     
     
  #    
  #    (unique(sun_down)-unique(sun_up))*defined_sects + unique(sun_up)) %>%
  # map(~which.min(abs(data %>% pull(instant_of_day) - .x))) %>%
  # unlist() %>%
  # slice(data, .) -> time_outputs

}
```

```{r}
outputs %>%
      ungroup() %>%
      nest(daily_data = c(profit, instant_of_day, PPFD_umol_m2_s_instant, VPD_hourly, sun_up, sun_down, day_length)) %>%
      mutate(true_daily_profit = map(daily_data, calc_defined_points, c(9/24,12/24,15/24))) %>%
  View()
```














```{r}

calc_mult_points <- function(data, num_sects){


slice(data, 1) %>%
  pull(profit) -> night_profits
  
unique(data %>% pull(day_length)/(num_sects-1))->day_frac

with(data, seq(from = unique(sun_up), to = unique(sun_down), by = day_frac)) %>%
    map(~which.min(abs(data %>% pull(instant_of_day) - .x))) %>%
    unlist() %>%
    slice(data, .) -> time_outputs

  with(data, seq(from = unique(sun_up) - 0.5*day_frac, to = unique(sun_down) - 0.5*day_frac, by = day_frac)) %>%
    map(~which.min(abs(data %>%
                         pull(instant_of_day) - .x))) %>%
    unlist() %>%
    slice(data, .) -> profit_outputs


   times <- c(time_outputs$instant_of_day[1] - time_outputs$sun_up[1], diff(time_outputs$instant_of_day))
  profits <- profit_outputs$profit
  
  day_profit <- sum(times*profits)


  total_profit <- sum(times*profits) + night_profits*(1-unique(data$day_length))
  
  # tibble(day_profit = rep(day_profit, num_sects*2), total_profit = rep(total_profit, num_sects*2), x_coords = rep(time_outputs$instant_of_day, each = 2), y_coords = c(0, rep(profit_outputs$profit[-1], each = 2), 0))

  total_profit
  
}
```


```{r}
nseq = 5

soil_params <- set_params_soil(day = seq(1,180,length.out = nseq), evap_routine = "1")
```




```{r}
outputs <- calc_daily_model(soil_params)

saveRDS(outputs, "outputs.RDS")
```


```{r}
num_sects <- seq(2,4)

map(num_sects, ~outputs %>%
      ungroup() %>%
      nest(daily_data = c(profit, instant_of_day, PPFD_umol_m2_s_instant, VPD_hourly, sun_up, sun_down, day_length)) %>%
      mutate(true_daily_profit = map_dbl(daily_data, ~plant:::trapezium(.x$instant_of_day, .x$profit))) %>%
      mutate(estimated_daily_profit_mult = map(daily_data, calc_mult_points, .x)) %>%
      mutate(num_sects = .x)
) %>%
  bind_rows()%>%
  group_by(num_sects) %>%
  mutate(rmsd = sqrt(sum((true_daily_profit - unlist(estimated_daily_profit_mult))^2)/length(true_daily_profit))) -> outputs_integrated
```


```{r}
outputs_integrated %>%
  ggplot(aes(x = true_daily_profit , y = unlist(estimated_daily_profit_mult))) +
  geom_point(aes(col = num_sects)) +
  geom_abline(slope = 1, intercept = 0.15)

```

```{r}
outputs %>%
  group_by(day) %>%
  filter(profit == max(profit)) -> outputs_summarised

outputs_summarised$instant_of_day
outputs_summarised$sun_up
outputs_summarised$sun_down
outputs_summarised$day_length

(outputs_summarised$instant_of_day - outputs_summarised$sun_up) / outputs_summarised$day_length
```


















```{r}
num_sects <- seq(2,100)

map(num_sects, ~outputs %>%
      ungroup() %>%
      nest(daily_data = c(profit, instant_of_day, PPFD_umol_m2_s_instant, VPD_hourly, sun_up, sun_down, day_length)) %>%
      mutate(true_daily_profit = map_dbl(daily_data, ~plant:::trapezium(.x$instant_of_day, .x$profit))) %>%
      mutate(estimated_daily_profit_mult = map(daily_data, calc_mult_points, .x)) %>%
      mutate(num_sects = .x)
) %>%
  bind_rows() -> outputs_integrated

outputs_integrated %>%
  group_by(num_sects) %>%
  summarise(rmsd = sum((true_daily_profit - unlist(estimated_daily_profit_mult))^2)/length(true_daily_profit)) %>%
  ggplot(aes(x = rmsd, y = num_sects)) +
  geom_path()


%>%
  nest(profits = c(true_daily_profit, estimated_daily_profit_mult, day, num_sects)) %>%
  mutate(rmsd = map_dbl(profits, ~sqrt(sum((.x$true_daily_profit - unlist(.x$estimated_daily_profit_mult))^2)/length(.x$true_daily_profit))))-> outputs_integrated
```

```{r}
outputs_integrated %>%
  ggplot() +
  geom_point(aes(x = true_daily_profit, y = unlist(estimated_daily_profit_mult), col = day)) +
  geom_line(aes(x = true_daily_profit, y = unlist(estimated_daily_profit_mult), group = num_sects, linetype = as.factor(num_sects))) +
  geom_abline(intercept = 0, slope = 1)





outputs_integrated %>% 
  slice(1) %>%
  unnest(estimated_daily_profit_mult) %>% 
  unnest(daily_data) %>%
  ggplot(aes(x=instant_of_day, y= profit)) +
  geom_polygon(aes(x = x_coords,  y= y_coords), alpha = 0.5, fill = "black") +
  geom_line(colour = "red", size = 2) 
```


```{r}
outputs_integrated %>%
  pivot_longer(contains("estimated")) %>%
  ggplot(aes(x = true_daily_profit, y = value, col = name)) + 
  geom_point()

cor(outputs_integrated$true_daily_profit, outputs_integrated$estimated_daily_profit_1)
cor(outputs_integrated$true_daily_profit, outputs_integrated$estimated_daily_profit_3)

outputs_integrated %>%
  ggplot(aes(x = true_daily_profit, y = estimated_daily_profit, col = as.factor(day))) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0)

outputs_integrated$daily_data[[1]] %>%
  slice(101)

outputs %>%
  filter(day == 1) %>%
  ggplot() +
  geom_polygon(data = outputs_integrated$daily_data[[1]][101,] %>% slice(rep(1:n(), each = 2))  %>% pivot_longer(contains("sun")),aes(x=value[c(1,3,2,4)], y = c(0,profit[2],profit[4],0)), fill = "black") +
  geom_polygon(data = outputs_integrated$daily_data[[1]][1,] %>% slice(rep(1:n(), each = 2))  %>% pivot_longer(contains("sun")),aes(x=c(0,0,value[1],value[1]), y = c(profit[1],0,0,profit[1])), fill = "black") +
  geom_polygon(data = outputs_integrated$daily_data[[1]][1,] %>% slice(rep(1:n(), each = 2))  %>% pivot_longer(contains("sun")),aes(x=c(value[2],value[2],1,1), y = c(profit[1],0,0,profit[1])), fill = "black") +
  geom_line(aes(x = instant_of_day, y = profit))


outputs %>%
  filter(day == 1) %>%
  pull(profit)[1] -> night_profits
  
  unique(data$day_length/(num_sects-1))->day_frac
  
  
  with(data, seq(from = unique(sun_up), to = unique(sun_down), by = day_frac))[2:num_sects] %>%
    map(~which.min(abs(data$instant_of_day - .x))) %>%
    unlist() %>%
    slice(data, .) -> time_outputs
  
  
  with(data, seq(from = unique(sun_up) - 0.5*day_frac, to = unique(sun_down) - 0.5*day_frac, by = day_frac))[2:num_sects] %>%
    map(~which.min(abs(data$instant_of_day - .x))) %>%
    unlist() %>%
    slice(data, .) -> profit_outputs
  
  
  times <- c(time_outputs$instant_of_day[1] - time_outputs$sun_up[1], diff(time_outputs$instant_of_day))
  profits <- profit_outputs$profit
  
  day_profit <- sum(times*profits)
  night_profit <- night_profits * (1-unique(data$day_length))
  
  day_profit+night_profit  
  
  
  
  ggplot() +
  geom_polygon(data = outputs_integrated$daily_data[[1]][101,] %>% slice(rep(1:n(), each = 2))  %>% pivot_longer(contains("sun")),aes(x=value[c(1,3,2,4)], y = c(0,profit[2],profit[4],0)), fill = "black") +
  geom_polygon(data = outputs_integrated$daily_data[[1]][1,] %>% slice(rep(1:n(), each = 2))  %>% pivot_longer(contains("sun")),aes(x=c(0,0,value[1],value[1]), y = c(profit[1],0,0,profit[1])), fill = "black") +
  geom_polygon(data = outputs_integrated$daily_data[[1]][1,] %>% slice(rep(1:n(), each = 2))  %>% pivot_longer(contains("sun")),aes(x=c(value[2],value[2],1,1), y = c(profit[1],0,0,profit[1])), fill = "black") +
  geom_line(aes(x = instant_of_day, y = profit))



```


