---
title: "Getting started with the plant model"
author:
- Daniel Falster
- Andrew O'Reilly-Nugent
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{plant}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

# Background

This page contains a brief introduction to get you started with `plant`. 
  
At a high level, `plant` has two key use cases - growing individuals or growing patches. Growing either is dependent on the defined strategy (physiological parameters), the environment and the starting point. By modifying these *insert word here* you can grow different individuals or patches of species.
  
  XXXX diagram here
  
More extensive information and tutorials are available, such as:

**Details of the modelling approaches (concepts):**

[Modelling demography of individuals, patches and metapopulations](https://traitecoevo.github.io/plant/articles/demography.html)  
[The `FF16` physiological strategy model](https://traitecoevo.github.io/plant/articles/demography.html)  

**Details of using `plant` in R:**

- [Individuals](https://traitecoevo.github.io/plant/articles/individuals.html)  
- [Patches of competing individuals (patch level dynamics)](https://traitecoevo.github.io/plant/articles/patch.html)  
- [Finding demographic equilibrium](https://traitecoevo.github.io/plant/articles/equilibrium.html)  
- [Emergent properties of patches](https://traitecoevo.github.io/plant/articles/emergent.html)  
- [Calculating fitness](https://traitecoevo.github.io/plant/articles/fitness.html)  
- [The cohort spacing algorithm](https://traitecoevo.github.io/plant/articles/cohort_spacing.html)  
- [Modifying parameters of strategies (modifying parameters of physiological model)](https://traitecoevo.github.io/plant/articles/parameters.html)  
- [Implementing a new strategy](https://traitecoevo.github.io/plant/articles/strategy.html)  

# Setup

First, load plant, tidyverse and purrr (for working with list objects):

```{r}
library(plant)
library(tidyverse)
library(purrr)
```
For a full list of available functions run library(help=plant), or see the [online reference](https://traitecoevo.github.io/plant/reference/index.html).



# Strategy objects

Strategies are the corner stone of `plant`, describing the system of dynamical equations that determine processes such as growth, reproduction and mortality. The `plant` includes the `FF16` strategy for you to get started.

A strategy object holds two kinds of parameters, those that relate to physiological processes of the model and control parameters that are used by the `plant` solver. The physiological parameters are strategy specific, often describing traits or rates of individuals and their effects on the environment, while control parameters are usually general to all `plant` models.

You can feed these strategies into either individuals or patches to alter the solver outcomes. 

For definitions of each of these parameters see [Concepts: FF16 Strategy tables](https://traitecoevo.github.io/plant/articles/physiology.html#tables).

For further information on how to adjust the strategies see [Modifying parameters of strategies](https://traitecoevo.github.io/plant/articles/parameters.html)

```{r}
s <- FF16_Strategy()
str(s)
```




# Individuals

We can define one or more individuals for a given strategy. 

These are accessed using the `Individual` class:

```{r}
ind = FF16_Individual()
```

noting that `FF16_Individual` uses the `FF16_Strategy` by default (see `?FF16_Individual` for more information).

We can see that our individual also shares the `FF16_Environment` (more on that soon) and a number of rates and functions for us to explore. The [Individuals vignette](https://traitecoevo.github.io/plant/articles/individuals.html) describes the nuts and bolts of all these functions, for now we're only going to grow and plot our individual's height.

```{r}
str(ind)
```
First we set a fixed environment (here `1.0` represents full light exposure in an open canopy) then use the `grow_plant_to_time` function to grow our individual for a range of time steps. 

```{r}
env <- FF16_fixed_environment(1.0)
times <- seq(0, 50, length.out = 101)
result <- grow_plant_to_time(ind, times, env)
```

Examining our result, we see a matrix of our state variables at each timestep

```{r}
result$state %>%
  head()

# head(result$state)
```

Which we can plot against time

```{r}
#need to create a function to convert individual results to tidy-format
#just do ggplot for now
result$state %>%
  as_tibble() %>%
  bind_cols(times = times) %>%
  ggplot() +
  geom_line(aes(x=times, y=height), size=1.5) +
  theme_classic()

# plot(times, result$state[,"height"])
```


You can find out more about how to grow individuals [under the Individual plants example](https://traitecoevo.github.io/plant/articles/individuals.html) OR if you're wanting to learn more about the concept and equations underlying individuals you can find them under [Concepts: demography of plants, patches and metacommunities](https://traitecoevo.github.io/plant/articles/demography.html#individual-plants)


# Patches Fiona dont touch

Concept link for [patches](https://traitecoevo.github.io/plant/articles/demography.html#patches-of-competing-plants-size-structured-populations) .

While we can torture our individual into all sorts of shapes and sizes, it's often more interesting to see how many individuals interact. `plant` describes groups of individuals as Cohorts that interact within a shared Patch. Cohorts are groups individuals of roughly the same age. As cohorts grow, they often alter their environment. In the `FF16` Strategy, individuals intercept light and shade other cohorts within the patch.

"Solving" a Patch therefore means stepping cohorts through time, integrating the rate of change on individuals to describe their state (such as height) and integrating the impact their state has on other cohorts in a patch. While it's possible to solve a Patch for very long time periods, in reality they are more likely to be disturbed and reset. By default `plant` starts with a bare Patch and introduces successive cohorts, stepping them through time, until the average disturbance related mortality has wiped the patch bare again.

First we load some parameters for our FF16 Strategy and set the mean disturbance interval

```{r}
params <- scm_base_parameters("FF16")
params$disturbance_mean_interval <- 30.0
```

Then we load a patch by applying those parameters to a FF16 Species with a leaf mass area of 0.0825 (admittedly this could be simpler, but the [Patch vignette](https://traitecoevo.github.io/plant/articles/patch.html) explains what is going on)

```{r}
patch <- expand_parameters(trait_matrix(0.0825, "lma"), params, mutant = FALSE)
```

Then we run `plant` solver (SCM) to step the patch through time

```{r}
result <- run_scm_collect(patch)
```

If you're working through this yourself, the SCM solver should be blazingly fast. Our results contain the timesteps the patch was solved at, the species in the patch, the environment at each timestep, `p` the patch parameters, and two entries related to the metapopulation of patches: seed rain and patch density

```{r}
str(result, max.level = 1)
```
We'll explain these latter entries, but for now we focus species and the patch environment. The species object is a N-dimensional array describing each state, for each cohort at each timestep

```{r}
str(result$species)
```
Let's look at height. Each line represents the height of a cohort of individuals over time, beginning from the point at which the cohort recruited into the patch. Notably, the first cohorts follow much the same growth curve as our individual above, but subsequent cohorts have a bumpier ride, with growth slowing as the canopy closes over

```{r}
result %>%
  tidy_patch() -> tidy_result

tidy_result%>%
  pluck("species") %>%
  drop_na() %>%
  ggplot() +
  geom_line(aes(x = time, y = height, group = cohort), alpha = 0.25) 

# t <- result$time
# h <- result$species[[1]]["height", , ]
# 
# matplot(t, h, lty=1, col=make_transparent("black", 0.25), type="l",
#         las=1, xlab="Time (years)", ylab="Height (m)")

```
To see the change in canopy openness over time we can explore the patch Environment. Lets look at year 20 first, which corresponds to the 99th timestep in our model (not all timesteps are equal!) Our FF16 environment is described in terms of canopy openness, with 1.0 being completely open and 0.0 being completely shaded. We see that the shortest cohorts experience intense shading while taller cohorts enjoy full sunlight:

```{r}
tidy_result %>%
  pluck("env") %>%
  filter(step == "99") %>%
  ggplot() +
  geom_line(aes(x=height, y = canopy_openness), size=1.5) +
  theme_classic()

# env <- result$env[[99]]
# plot(env)
```
If we look at the light environment at the forest floor (height = 0.0) we can see that it varies through time as older cohorts thin out and gaps form

```{r}
tidy_result%>%
  pluck("env") %>%
  filter(height == 0) %>%
  ggplot() +
  geom_line(aes(x= time, y=canopy_openness), size=1.5) +
  theme_classic()

# env_min <- lapply(result$env, function(e) e[1, "canopy_openness"])
# plot(t, env_min)
```

This suggests that competition is density dependent and that our earlier figure of height over time is incomplete as many individuals will die out before reaching their potential maximum height. The final variable of our species `state` array is the log density of the cohorts, which we can use to weight the growth trajectories to show thinning

```{r}
# Relativise the log densities onto (-4, max)
rel <- function(x, xmin = -4) {
  x[x < xmin] <- xmin
  xmax <- max(x, na.rm=TRUE)
  (x - xmin) / (xmax - xmin)
}

tidy_result %>%
  pluck("species") %>%
  mutate(log_density = log(density)) %>%
  mutate(relative_log_density = rel(log_density)) %>%
  ggplot()+
  geom_line(aes(x = time, y = height, group = cohort, alpha=relative_log_density)) +
  scale_alpha(range=c(0,1)) 

# d <- result$species[[1]]["log_density", , ]
# 
# rd <- rel(d)
# 
# # R doesn't seem to offer a way to plot lines that vary in colour, so
# # this is quite roundabout using `segments`, shaded by the density at
# # the first part of the line segment:
# n <- length(t)
# x <- matrix(rep(t, ncol(h)), nrow(h))
# col <- matrix(make_transparent("black", rd), nrow(d))
# 
# plot(NA, xlim=range(t), ylim=range(h, na.rm=TRUE),
#      las=1, xlab="Time (years)", ylab="Cohort height (m)")
# segments(x[-1, ], h[-1, ], x[-n, ], h[-n, ], col=col[-n, ], lend="butt")
```

# Meta-populations

🚧 Coming soon 🚧
